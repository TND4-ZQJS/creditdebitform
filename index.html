<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Credit Card Enrolment Web Filler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0; padding: 0;
  }
  .container {
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 20px;
  }
  h1,h2,h3 {
    margin: 0 0 10px;
    color: #004080;
  }
  .section {
    margin-bottom: 30px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
  }
  .row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  label {
    display: flex;
    flex-direction: column;
    font-size: 14px;
  }
  input, select {
    padding: 6px;
    font-size: 14px;
  }
  input[type=checkbox] {
    width: auto;
  }
  .inline {
    flex-direction: row;
    align-items: center;
  }
  button {
    padding: 8px 14px;
    background: #007aff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button.secondary {
    background: #aaa;
  }
  canvas {
    width: 100%;
    height: 150px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #fff;
  }
</style>
</head>
<body>
<div class="container">
<h1>Credit Card Enrolment Form</h1>

<!-- ================== SECTION A/B/C (Your current logic) ================== -->
<section class="section">
  <h2>Section C - Payment by Third Party</h2>
  <label class="inline">
    <input type="checkbox" id="ThirdPP_Yes"> Payment by Third Party Payor (other than Policyowner)
  </label>

  <div id="thirdPP_ic_wrap" style="display:none;">
    <label class="inline">
      <input type="checkbox" id="ThirdPP_SubmittedNRIC"> Prepare IC Copy to be submitted together with this form
    </label>
  </div>

  <div id="thirdPP_fields" style="display:none;">
    <div class="row">
      <label style="flex:1">
        Third Party Payor’s Name
        <input type="text" id="ThirdPP_Name">
      </label>
    </div>
    <div class="row">
      <label>Date of Birth - Day
        <select id="ThirdPP_Day"></select>
      </label>
      <label>Month
        <select id="ThirdPP_Month"></select>
      </label>
      <label>Year
        <input type="number" id="ThirdPP_Year" placeholder="YYYY">
      </label>
    </div>
    <div class="row">
      <label>IC No.
        <input type="text" id="ThirdPP_NIRC">
      </label>
    </div>
    <!-- Add the rest of your ThirdPP fields here -->
  </div>
</section>

<!-- ================== SECTION D - PDPA ================== -->
<section class="section">
  <h2>Section D - PDPA</h2>
  <label class="inline">
    <input type="checkbox" id="PDPA"> I agree to PDPA terms
  </label>
</section>

<!-- ================== SECTION E - SIGNATURE ================== -->
<section class="section" id="sectionE">
  <h2>Section E - Signature</h2>

  <h3>Policy Owner</h3>
  <div class="row">
    <label style="flex:1">
      Policy Owner’s Name
      <input type="text" id="Sign_OwnerName" placeholder="AS PER NRIC">
    </label>
    <label class="inline" style="align-self:flex-end">
      <input type="checkbox" id="copyFromCC"> Same as Card Owner
    </label>
  </div>

  <div class="row">
    <label style="flex:1">
      IC No.
      <input type="text" id="Sign_OwnerNIRC" inputmode="numeric">
    </label>
  </div>

  <div class="row">
    <label style="flex:1">
      Signed at (State)
      <select id="Sign_State"></select>
    </label>
    <label>
      Signed Date (DD)
      <select id="Sign_Date"></select>
    </label>
    <label>
      Signed Year (YYYY)
      <select id="Sign_Year"></select>
    </label>
  </div>

  <label>Signature (Owner)</label>
  <canvas id="Owner_SignPad"></canvas>
  <button type="button" id="Owner_SignClear" class="secondary">Clear Owner Signature</button>

  <hr>
  <div id="payorSignatureSection" style="display:none;">
    <h3>Fill and Sign only if Payor is not Policy Owner</h3>
    <div class="row">
      <label style="flex:1">
        Payor’s Name
        <input type="text" id="Sign_PayorName" placeholder="AS PER NRIC">
      </label>
      <label class="inline" style="align-self:flex-end">
        <input type="checkbox" id="copyFromThirdPP_Name"> Same as Third Party Payor
      </label>
    </div>

    <div class="row">
      <label style="flex:1">
        Payor’s IC No.
        <input type="text" id="Sign_PayorNIRC" inputmode="numeric">
      </label>
      <label class="inline" style="align-self:flex-end">
        <input type="checkbox" id="copyFromThirdPP_NIRC"> Same as Third Party Payor
      </label>
    </div>

    <label>Signature (Payor)</label>
    <canvas id="Payor_SignPad"></canvas>
    <button type="button" id="Payor_SignClear" class="secondary">Clear Payor Signature</button>
  </div>
</section>

<div class="row">
  <button id="generatePDF">Generate PDF</button>
</div>

</div>

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
const $ = id => document.getElementById(id);

// autoBindSave helper
function autoBindSave(el){
  const key = el.id;
  if(localStorage.getItem(key)){
    el.value = localStorage.getItem(key);
    if(el.type === "checkbox") el.checked = localStorage.getItem(key) === "true";
  }
  el.addEventListener("input", ()=> {
    localStorage.setItem(key, el.type === "checkbox" ? el.checked : el.value);
  });
}

// Populate dropdowns
(function(){
  const states = ["SELANGOR","K.LUMPUR","MELAKA","N.SEMBILAN","JOHOR","KEDAH","KELANTAN","PAHANG","PERAK","PERLIS","PULAU PINANG","SABAH","SARAWAK","TERENGGANU","LABUAN","PUTRAJAYA"];
  states.forEach(s=>{
    let opt=document.createElement("option");
    opt.value=s; opt.textContent=s;
    $("Sign_State").appendChild(opt);
  });
  for(let d=1;d<=31;d++){
    let opt=document.createElement("option");
    opt.value=String(d).padStart(2,"0");
    opt.textContent=opt.value;
    $("Sign_Date").appendChild(opt);
  }
  for(let y=2025;y<=2030;y++){
    let opt=document.createElement("option");
    opt.value=String(y);
    opt.textContent=String(y);
    $("Sign_Year").appendChild(opt);
  }
})();

// Show/hide third party fields
function updateThirdPPUI(){
  $("thirdPP_ic_wrap").style.display = $("ThirdPP_Yes").checked ? "block" : "none";
  $("thirdPP_fields").style.display = ($("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked) ? "block" : "none";
  $("payorSignatureSection").style.display = ($("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked) ? "block" : "none";
}
$("ThirdPP_Yes").addEventListener("change", updateThirdPPUI);
$("ThirdPP_SubmittedNRIC").addEventListener("change", updateThirdPPUI);
updateThirdPPUI();

// Auto-uppercase names
["Sign_OwnerName","Sign_PayorName","ThirdPP_Name"].forEach(id=>{
  $(id)?.addEventListener("input",e=>{
    if(e.target.id!=="email") e.target.value = e.target.value.toUpperCase();
  });
});

// "Same as" checkboxes
$("copyFromCC").addEventListener("change", ()=>{
  if($("copyFromCC").checked){
    $("Sign_OwnerName").value = ($("CardName")?.value || "").toUpperCase();
  }
});
$("copyFromThirdPP_Name").addEventListener("change", ()=>{
  if($("copyFromThirdPP_Name").checked){
    $("Sign_PayorName").value = ($("ThirdPP_Name")?.value || "").toUpperCase();
  }
});
$("copyFromThirdPP_NIRC").addEventListener("change", ()=>{
  if($("copyFromThirdPP_NIRC").checked){
    $("Sign_PayorNIRC").value = $("ThirdPP_NIRC")?.value || "";
  }
});

// Signature pad init
function initSignPad(canvasId, clearBtnId, storageKey){
  const canvas=$(canvasId), ctx=canvas.getContext("2d");
  function resize(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = 150 * ratio;
    ctx.scale(ratio, ratio);
  }
  resize(); window.addEventListener("resize", resize);
  let drawing=false;
  function pos(e){
    const r=canvas.getBoundingClientRect();
    return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,
            y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};
  }
  function start(e){ e.preventDefault(); drawing=true; ctx.beginPath(); const p=pos(e); ctx.moveTo(p.x,p.y); }
  function move(e){ if(!drawing) return; e.preventDefault(); const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
  function end(){ if(!drawing) return; drawing=false; localStorage.setItem(storageKey, canvas.toDataURL()); }
  canvas.addEventListener("mousedown", start); canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end); canvas.addEventListener("mouseleave", end);
  canvas.addEventListener("touchstart", start, {passive:false});
  canvas.addEventListener("touchmove", move, {passive:false});
  canvas.addEventListener("touchend", end);
  $(clearBtnId).addEventListener("click", ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); localStorage.removeItem(storageKey); });
  const saved=localStorage.getItem(storageKey);
  if(saved){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,canvas.width,canvas.height); img.src=saved; }
}
initSignPad("Owner_SignPad","Owner_SignClear","sig_owner");
initSignPad("Payor_SignPad","Payor_SignClear","sig_payor");

// Fill PDF
$("generatePDF").addEventListener("click", async ()=>{
  const pdfBytes = await fetch("YOUR_TEMPLATE.pdf").then(r=>r.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
  const form = pdfDoc.getForm();

  // Section C checkboxes
  form.getCheckBox("ThirdPP_Yes").check($("ThirdPP_Yes").checked);
  form.getCheckBox("ThirdPP_SubmittedNRIC").check($("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked);

  // Section D
  form.getCheckBox("PDPA").check($("PDPA").checked);

  // Section E - Owner
  form.getTextField("Sign_OwnerName").setText($("Sign_OwnerName").value);
  form.getTextField("Sign_OwnerNIRC").setText($("Sign_OwnerNIRC").value);
  form.getTextField("Sign_State").setText($("Sign_State").value);
  form.getTextField("Sign_Date").setText($("Sign_Date").value);
  form.getTextField("Sign_Year").setText($("Sign_Year").value);

  const pages = pdfDoc.getPages();
  const sigPage = pages[0]; // adjust page index
  if(localStorage.getItem("sig_owner")){
    const ownerImg = await pdfDoc.embedPng(localStorage.getItem("sig_owner"));
    sigPage.drawImage(ownerImg,{x:360,y:150,width:160,height:50});
  }
  if($("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked){
    form.getTextField("Sign_PayorName").setText($("Sign_PayorName").value);
    form.getTextField("Sign_PayorNIRC").setText($("Sign_PayorNIRC").value);
    if(localStorage.getItem("sig_payor")){
      const payorImg = await pdfDoc.embedPng(localStorage.getItem("sig_payor"));
      sigPage.drawImage(payorImg,{x:360,y:90,width:160,height:50});
    }
  }

  const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
  const link = document.createElement("a");
  link.href = pdfDataUri;
  link.download = "Filled_Form.pdf";
  link.click();
});
</script>
</body>
</html>
