<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Credit Card Form Filler — Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--accent:#007aff;--muted:#666;}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
    main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
    h1{margin-top:0;font-size:1.25rem}
    .section{background:#fbfbfd;border:1px solid #eee;padding:12px;border-radius:8px;margin:12px 0}
    .section h2{margin:0 0 8px 0}
    label{display:block;margin:8px 0;font-size:0.95rem}
    input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
      width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px;font-size:1rem;
    }
    textarea{resize:none;overflow:hidden}
    .inline{display:inline-flex;align-items:center;margin-right:12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .header-row{align-items:center}
    .amount{display:flex;flex-direction:column;min-width:160px}
    .card-number-block .card-number-inputs{display:flex;gap:8px;margin-top:8px}
    .card-digit{width:80px;padding:8px;border-radius:8px;border:1px solid #ddd;text-align:center;font-size:1.05rem}
    .card-digit:focus{outline:2px solid rgba(0,122,255,0.15)}
    .small label{flex:1}
    .muted{color:var(--muted);font-size:0.85rem}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:#999}
    .actions{display:flex;gap:12px;align-items:center}
    footer{margin-top:12px;color:var(--muted)}
    .policy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .policy{background:#fff;padding:10px;border-radius:8px;border:1px solid #eee}
    .policy h3{margin:0 0 8px 0;font-size:0.95rem}
    .tiny{font-size:0.85rem;color:var(--muted)}
    @media (max-width:720px){
      .policy-grid{grid-template-columns:1fr}
      .card-digit{width:60px}
      .row{flex-direction:column;align-items:stretch}
    }

    /* New styles for signature and save indicator */
    #signatureCanvas {
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      height: 120px;
      background: #fff;
      touch-action: none;
      display: block;
    }
    #saveStatus{
      position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff; padding:6px 10px; border-radius:6px; font-size:0.85rem; opacity:0; transition:opacity .25s;
    }
    /* Uppercase visual style for specific sections */
    #CardName, #Sign_OwnerName, #ThirdPP_Name, input[id^='Policy_OwnerName'] { text-transform: uppercase; }

    /* Policy entry style */
    .policy-entry {
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .policy-entry h3 {
        margin: 0 0 8px 0;
        font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <main>
    <h1>Credit Card Enrolment — Prototype</h1>

    <section class="section header">
      <h2>Header</h2>
      <label class="row inline">
        <input id="CCAgree" type="checkbox">I agree for recurring credit/debit card services
      </label>

      <div class="row header-row">
        <label class="inline">
          <input id="Onetimecharge_alloutstanding" type="checkbox"> Charge all outstanding
        </label>

        <label class="inline">
          <input id="Onetimecharge_tick" type="checkbox"> Request one-time charge
        </label>

        <label class="amount">
          Amount (RM)
          <input id="Onetimecharge_amt" type="number" step="0.01" disabled placeholder="0.00" />
        </label>
      </div>
    </section>

    <section class="section" id="sectionA">
      <h2>Section A — Policy Entries</h2>
      <div id="policiesContainer"></div>
      <div class="row">
        <button id="addPolicy">+ Add Another Policy</button>
        <small class="muted">Up to 4 policies</small>
      </div>
    </section>

    <section class="section">
      <h2>Card Details</h2>

      <label>Cardholder"s Name (as on I/C)
        <input id="CardName" type="text" placeholder="As printed on card">
      </label>

      <div class="row">
        <label class="inline"><input name="cardType" id="CC_Tick" type="radio"> Credit Card</label>
        <label class="inline"><input name="cardType" id="DebitC_Tick" type="radio"> Debit Card</label>
      </div>

      <div class="card-number-block">
        <label>Card Number</label>
        <div class="card-number-inputs">
          <input class="card-digit" id="CardNo_1" maxlength="4" inputmode="numeric" pattern="\d*">
          <input class="card-digit" id="CardNo_2" maxlength="4" inputmode="numeric" pattern="\d*">
          <input class="card-digit" id="CardNo_3" maxlength="4" inputmode="numeric" pattern="\d*">
          <input class="card-digit" id="CardNo_4" maxlength="4" inputmode="numeric" pattern="\d*">
        </div>
        <small class="muted">Type 4 digits per box. Paste full 16-digit number — it will auto-split.</small>
      </div>

      <div class="row small">
        <label>Expiry MM
          <input id="CardExpry_M" maxlength="2" inputmode="numeric" placeholder="MM">
        </label>
        <label>Expiry YY
          <input id="CardExpry_Y" maxlength="2" inputmode="numeric" placeholder="YY">
        </label>
        <label>Issuing Bank
          <input id="CardBank" type="text">
        </label>
      </div>

      <div class="row">
        <label class="inline"><input name="brand" id="Visa_Tick" type="radio"> Visa</label>
        <label class="inline"><input name="brand" id="Master_Tick" type="radio"> Master</label>
      </div>
    </section>

    <section class="section">
      <h2>Signature</h2>
      <div class="sig-preview" id="preview_signature">
        <span>Tap here to sign</span>
      </div>
      <div class="row">
        <button id="clearSig" class="secondary">Clear Signature</button>
      </div>

      <div class="row small">
        <label>Signer (Owner) Name
          <input id="Sign_OwnerName" type="text">
        </label>
        <label>Owner NRIC
          <input id="Sign_OwnerNIRC" type="text">
        </label>
      </div>

      <div class="row small">
        <label>Sign Date (DD)
          <input id="Sign_Date" maxlength="2" inputmode="numeric">
        </label>
        <label>Sign Month
          <input id="Sign_Month" maxlength="2" inputmode="numeric">
        </label>
        <label>Sign Year (YYYY)
          <input id="Sign_Year" maxlength="4" inputmode="numeric">
        </label>
        <label>State
          <input id="Sign_State" type="text">
        </label>
      </div>
    </section>

    <section class="section">
      <h2>Third Party / Source</h2>
      <label><input id="ThirdPP_Yes" type="checkbox"> Third party payor?</label>
      <label>Third Party Name <input id="ThirdPP_Name" type="text"></label>
      <label>Third Party Email <input id="ThirdPP_Email" type="email"></label>

      <h3>Source of Funds (select any)</h3>
      <label><input id="ThirdPP_SourceFund_Self" type="checkbox"> Self</label>
      <label><input id="ThirdPP_SourceFund_Parent" type="checkbox"> Parent(s)</label>
      <label><input id="ThirdPP_SourceFund_Spouse" type="checkbox"> Spouse</label>
      <label><input id="ThirdPP_SourceFund_Others" type="checkbox"> Others</label>
      <label>If others specify <input id="ThirdPP_SourceFund_Others_Write" type="text"></label>

      <h3>Source of Wealth (select any)</h3>
      <label><input id="ThirdPP_SourceWealth_EmployBus" type="checkbox"> Employment/Business</label>
      <label><input id="ThirdPP_SourceWealth_Invest" type="checkbox"> Investment</label>
      <label><input id="ThirdPP_SourceWealth_Inherit" type="checkbox"> Inheritance</label>
      <label><input id="ThirdPP_SourceWealth_Savings" type="checkbox"> Savings</label>
      <label><input id="ThirdPP_SourceWealth_Parents" type="checkbox"> Parents</label>
      <label><input id="ThirdPP_SourceWealth_Spouse" type="checkbox"> Spouse</label>
      <label><input id="ThirdPP_SourceWealth_Others" type="checkbox"> Others</label>
      <label>If others specify <input id="ThirdPP_SourceWealth_Others_Write" type="text"></label>
    </section>

    <section class="section actions">
      <button id="generate">Generate PDF</button>
      <button id="resetAll" class="secondary">Reset All</button>
    </section>

    <footer>
      <small>Make sure <code>Credit Card Enrolment Form_LF4092_200524_fillable.pdf</code> is in the same folder.</small>
    </footer>
  </main>

  <div id="sigModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
    <div id="sigModalContent" style="background:#fff; padding:12px; border-radius:8px; display:flex; flex-direction:column; align-items:center; gap:10px; max-width:96%; width:720px;">
      <canvas id="sigCanvas" style="border:1px solid #ccc; border-radius:8px; touch-action:none; display:block;"></canvas>
      <div style="display:flex;gap:8px;">
        <button id="saveSigBtn">Done</button>
        <button id="clearSigBtn" class="secondary">Clear</button>
        <button id="cancelSigBtn" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <div id="saveStatus" style="position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff; padding:6px 10px; border-radius:6px; font-size:0.85rem; opacity:0; transition:opacity .25s;">Saved</div>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    /* ---------- CONFIG ---------- */
    const PDF_FILENAME = "Credit Card Enrolment Form_LF4092_200524_fillable.pdf";
    const MAX_POLICIES = 4;

    /* ---------- helpers ---------- */
    function $(id){return document.getElementById(id);}
    function safeSetText(form, name, text){
      try{ form.getTextField(name).setText(String(text || "")); } catch(e){ console.warn(`PDF field "${name}" not found.`); }
    }
    function safeCheck(form, name, checked){
      try{ const cb = form.getCheckBox(name); if (checked) cb.check(); else cb.uncheck(); } catch(e){ console.warn(`PDF checkbox "${name}" not found.`); }
    }
    function safeSelect(form, name, value){
      try { form.getRadioGroup(name).select(value); } catch(e){ console.warn(`PDF radio group "${name}" not found.`); }
    }

    /* ---------- Policies dynamic (updated) ---------- */
    const policiesContainer = $("policiesContainer");
    const addPolicyBtn = $("addPolicy");
    let policyCount = 0;

    function setupPolicyOwnerCheckbox(ownerInput, cardholderNameInput, checkbox) {
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          ownerInput.value = cardholderNameInput.value.toUpperCase();
        } else {
          ownerInput.value = '';
        }
        localStorage.setItem(ownerInput.id, ownerInput.value);
        localStorage.setItem(checkbox.id, checkbox.checked);
        showSaveStatus();
      });

      cardholderNameInput.addEventListener('input', () => {
        if (checkbox.checked) {
          ownerInput.value = cardholderNameInput.value.toUpperCase();
          localStorage.setItem(ownerInput.id, ownerInput.value);
          showSaveStatus();
        }
      });

      const savedCheckboxState = localStorage.getItem(checkbox.id);
      if (savedCheckboxState === 'true') {
        checkbox.checked = true;
        ownerInput.value = cardholderNameInput.value.toUpperCase();
      }
    }

    function createPolicyEntry(index) {
      const wrap = document.createElement("div");
      wrap.className = "policy-entry";
      wrap.dataset.index = index;

      const pNoLabel = document.createElement("label");
      pNoLabel.textContent = `Policy ${index} No.`;
      const pNoInput = document.createElement("input");
      pNoInput.type = "text";
      pNoInput.id = `PolicyNo_${index}`;
      pNoLabel.appendChild(pNoInput);
      wrap.appendChild(pNoLabel);

      const ownerRow = document.createElement("div");
      ownerRow.className = "row";

      const ownerNameLabel = document.createElement("label");
      ownerNameLabel.textContent = "Owner Name";
      ownerNameLabel.style.flex = "1";
      const ownerNameInput = document.createElement("input");
      ownerNameInput.type = "text";
      ownerNameInput.id = `Policy_OwnerName_${index}`;
      ownerNameLabel.appendChild(ownerNameInput);
      ownerRow.appendChild(ownerNameLabel);

      const sameOwnerLabel = document.createElement("label");
      sameOwnerLabel.className = "inline";
      sameOwnerLabel.style.flex = "none";
      const sameOwnerCheckbox = document.createElement("input");
      sameOwnerCheckbox.type = "checkbox";
      sameOwnerCheckbox.id = `sameAsCardholder_${index}`;
      sameOwnerLabel.appendChild(sameOwnerCheckbox);
      sameOwnerLabel.appendChild(document.createTextNode(" Same as Cardholder"));
      ownerRow.appendChild(sameOwnerLabel);
      wrap.appendChild(ownerRow);

      const premLabel = document.createElement("label");
      premLabel.textContent = "First Premium (RM)";
      const premInput = document.createElement("input");
      premInput.type = "text";
      premInput.id = `Policy_Premium_${index}`;
      premLabel.appendChild(premInput);
      wrap.appendChild(premLabel);

      if (index > 1) {
        const rem = document.createElement("button");
        rem.type = "button";
        rem.className = "secondary";
        rem.textContent = "Remove";
        rem.style.marginTop = "8px";
        rem.addEventListener("click", () => {
          localStorage.removeItem(`PolicyNo_${index}`);
          localStorage.removeItem(`Policy_OwnerName_${index}`);
          localStorage.removeItem(`sameAsCardholder_${index}`);
          localStorage.removeItem(`Policy_Premium_${index}`);
          wrap.remove();
          policyCount--;
          addPolicyBtn.disabled = false;
          reorganizePolicyIndices();
          showSaveStatus();
        });
        wrap.appendChild(rem);
      }
      
      // Set up the capitalization and checkbox logic
      const cardholderNameInput = $("CardName");
      setupPolicyOwnerCheckbox(ownerNameInput, cardholderNameInput, sameOwnerCheckbox);
      ownerNameInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.toUpperCase();
        debounceSave(() => saveElValue(e.target), 120)();
      });

      return wrap;
    }

    function addPolicy(){ if(policyCount>=MAX_POLICIES) return; policyCount++; policiesContainer.appendChild(createPolicyEntry(policyCount)); if(policyCount>=MAX_POLICIES) addPolicyBtn.disabled=true; }
    function reorganizePolicyIndices(){
      const nodes = Array.from(policiesContainer.querySelectorAll(".policy-entry"));
      policyCount = nodes.length;
      nodes.forEach((n, idx)=> {
        const oldIdx = n.dataset.index;
        const newIdx = idx+1;
        n.dataset.index=newIdx;
        
        const pNo = n.querySelector(`#PolicyNo_${oldIdx}`); if(pNo) pNo.id = `PolicyNo_${newIdx}`;
        const ownerName = n.querySelector(`#Policy_OwnerName_${oldIdx}`); if(ownerName) ownerName.id = `Policy_OwnerName_${newIdx}`;
        const checkbox = n.querySelector(`#sameAsCardholder_${oldIdx}`); if(checkbox) checkbox.id = `sameAsCardholder_${newIdx}`;
        const prem = n.querySelector(`#Policy_Premium_${oldIdx}`); if(prem) prem.id = `Policy_Premium_${newIdx}`;

        setupPolicyOwnerCheckbox(ownerName, $("CardName"), checkbox);
      });
      addPolicyBtn.disabled = policyCount >= MAX_POLICIES;
    }

    addPolicyBtn.addEventListener("click", addPolicy);
    addPolicy(); // start with 1

    /* ---------- Credit card number inputs ---------- */
    const ccDigits = [ $("CardNo_1"), $("CardNo_2"), $("CardNo_3"), $("CardNo_4") ];
    ccDigits.forEach((el, idx)=>{
      el.addEventListener("input", ()=>{ el.value = el.value.replace(/\D/g,'').slice(0,4); if(el.value.length===4 && idx<ccDigits.length-1) ccDigits[idx+1].focus(); });
      el.addEventListener("keydown", (e)=>{ if(e.key==="Backspace" && el.value.length===0 && idx>0) ccDigits[idx-1].focus(); });
      el.addEventListener("paste", (e)=>{
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = paste.replace(/\D/g,'').slice(0,16).padEnd(16,' ');
        for(let i=0;i<4;i++){ ccDigits[i].value = digits.slice(i*4, i*4+4).trim(); }
        for(let i=0;i<4;i++){ if(ccDigits[i].value.length<4){ ccDigits[i].focus(); break; } if(i===3) ccDigits[3].focus(); }
      });
    });

    /* ---------- Signature modal (shared) ---------- */
    const sigModal = $("sigModal"), sigCanvas = $("sigCanvas");
    const saveSigBtn = $("saveSigBtn"), clearSigBtn = $("clearSigBtn"), cancelSigBtn = $("cancelSigBtn");
    const signaturePreview = $("preview_signature");
    let sigCtx = sigCanvas.getContext('2d');
    let drawing = false;

    function resizeSigCanvas(){
      const dpr = window.devicePixelRatio || 1;
      const cssWidth = Math.min(window.innerWidth * 0.95, 700);
      const cssHeight = cssWidth / 3.3;
      sigCanvas.width = cssWidth * dpr;
      sigCanvas.height = cssHeight * dpr;
      sigCanvas.style.width = cssWidth + 'px';
      sigCanvas.style.height = cssHeight + 'px';
      sigCtx.setTransform(dpr,0,0,dpr,0,0);
      sigCtx.lineWidth = 2.5;
      sigCtx.lineCap = 'round';
      sigCtx.strokeStyle = '#000';
    }

    signaturePreview.addEventListener("click", () => {
      sigModal.style.display = 'flex';
      resizeSigCanvas();
      sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
      const saved = localStorage.getItem('signature_data');
      if(saved){
        const img = new Image();
        img.src = saved;
        img.onload = ()=> sigCtx.drawImage(img,0,0,sigCanvas.width/(window.devicePixelRatio||1), sigCanvas.height/(window.devicePixelRatio||1));
      }
    });

    sigCanvas.addEventListener('mousedown', e=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); });
    sigCanvas.addEventListener('mousemove', e=>{ if(!drawing) return; sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); });
    sigCanvas.addEventListener('mouseup', ()=>drawing=false);
    sigCanvas.addEventListener('mouseleave', ()=>drawing=false);
    sigCanvas.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(t.clientX-rect.left, t.clientY-rect.top); drawing=true; }, {passive:false});
    sigCanvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.lineTo(t.clientX-rect.left, t.clientY-rect.top); sigCtx.stroke(); }, {passive:false});
    sigCanvas.addEventListener('touchend', ()=>drawing=false);

    saveSigBtn.addEventListener('click', ()=>{
      const dataURL = sigCanvas.toDataURL();
      localStorage.setItem('signature_data', dataURL);
      signaturePreview.innerHTML = `<img src="${dataURL}" style="max-width:100%; max-height:100%;">`;
      sigModal.style.display = 'none';
      showSaveStatus();
    });

    clearSigBtn.addEventListener('click', ()=>{
      sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
    });

    cancelSigBtn.addEventListener('click', ()=>{
      sigModal.style.display = 'none';
    });

    $("clearSig").addEventListener("click", ()=>{
      localStorage.removeItem('signature_data');
      signaturePreview.innerHTML = `<span>Tap here to sign</span>`;
    });

    function restoreSignaturePreview(){
      const saved = localStorage.getItem('signature_data');
      if(saved) {
        signaturePreview.innerHTML = `<img src="${saved}" style="max-width:100%; max-height:100%;">`;
      }
    }
    restoreSignaturePreview();

    /* ---------- localStorage autosave + restore ---------- */
    const saveStatusEl = $("saveStatus");
    function showSaveStatus(){
      saveStatusEl.style.opacity = 1;
      clearTimeout(saveStatusEl._timer);
      saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
    }

    function debounceSave(fn, wait=150){
      let t;
      return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
    }

    function saveElValue(el){
      if(!el || !el.id) return;
      if(el.type === 'checkbox' || el.type === 'radio'){
          localStorage.setItem(el.id, el.checked);
      } else {
          localStorage.setItem(el.id, el.value);
      }
      showSaveStatus();
    }
    
    // Main event listener loop
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      const saved = localStorage.getItem(el.id);
      if(saved !== null) {
        if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = (saved === 'true');
        } else {
            el.value = saved;
        }
      }

      el.addEventListener("input", ()=>{
        // uppercase enforcement
        if( el.id.includes('Name') || el.id.includes('State') ){
          el.value = el.value.toUpperCase();
        }
        debounceSave(()=> saveElValue(el), 120)();
      });

      if (el.type === 'checkbox' || el.type === 'radio') {
        el.addEventListener('change', () => {
          localStorage.setItem(el.id, el.checked);
          showSaveStatus();
        });
      }
    });

    /* ---------- PDF Generation Logic ---------- */
    async function fillPDF(){
      try {
        $("generate").disabled = true;

        const res = await fetch(PDF_FILENAME);
        if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
        const bytes = await res.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);
        const form = pdfDoc.getForm();

        // Header
        safeCheck(form, "Recurring_Credit_Debit_Card_Tick", $("CCAgree").checked);
        safeCheck(form, "Onetimecharge_alloutstanding", $("Onetimecharge_alloutstanding").checked);
        safeCheck(form, "Onetimecharge_tick", $("Onetimecharge_tick").checked);
        safeSetText(form, "Onetimecharge_amt", $("Onetimecharge_amt").value);

        // Section A: Policies
        const policyNodes = Array.from(policiesContainer.querySelectorAll(".policy-entry"));
        policyNodes.forEach((node, idx) => {
          const i = idx + 1;
          safeSetText(form, `PolicyNo_${i}`, node.querySelector(`#PolicyNo_${i}`).value);
          safeSetText(form, `Policy_OwnerName_${i}`, node.querySelector(`#Policy_OwnerName_${i}`).value);
          safeSetText(form, `Policy_Premium_${i}`, node.querySelector(`#Policy_Premium_${i}`).value);
        });

        // Card Details
        safeSetText(form, "CardName", $("CardName").value);
        safeCheck(form, "CC_Tick", $("CC_Tick").checked);
        safeCheck(form, "DebitC_Tick", $("DebitC_Tick").checked);
        safeSetText(form, "CardNo_1", $("CardNo_1").value);
        safeSetText(form, "CardNo_2", $("CardNo_2").value);
        safeSetText(form, "CardNo_3", $("CardNo_3").value);
        safeSetText(form, "CardNo_4", $("CardNo_4").value);
        safeSetText(form, "CardExpry_M", $("CardExpry_M").value);
        safeSetText(form, "CardExpry_Y", $("CardExpry_Y").value);
        safeSetText(form, "CardBank", $("CardBank").value);
        safeCheck(form, "Visa_Tick", $("Visa_Tick").checked);
        safeCheck(form, "Master_Tick", $("Master_Tick").checked);

        // Signature
        safeSetText(form, "Sign_OwnerName", $("Sign_OwnerName").value);
        safeSetText(form, "Sign_OwnerNIRC", $("Sign_OwnerNIRC").value);
        safeSetText(form, "Sign_Date", $("Sign_Date").value);
        safeSetText(form, "Sign_Month", $("Sign_Month").value);
        safeSetText(form, "Sign_Year", $("Sign_Year").value);
        safeSetText(form, "Sign_State", $("Sign_State").value);

        // Embed signature
        const sigData = localStorage.getItem('signature_data');
        if (sigData) {
          const pages = pdfDoc.getPages();
          const pageForSig = pages[0];
          const img = await pdfDoc.embedPng(sigData);
          pageForSig.drawImage(img, { x: 42, y: 154, width: 180, height: 60 });
        }

        // Third Party
        safeCheck(form, "ThirdPP_Yes", $("ThirdPP_Yes").checked);
        safeSetText(form, "ThirdPP_Name", $("ThirdPP_Name").value);
        safeSetText(form, "ThirdPP_Email", $("ThirdPP_Email").value);
        safeCheck(form, "ThirdPP_SourceFund_Self", $("ThirdPP_SourceFund_Self").checked);
        safeCheck(form, "ThirdPP_SourceFund_Parent", $("ThirdPP_SourceFund_Parent").checked);
        safeCheck(form, "ThirdPP_SourceFund_Spouse", $("ThirdPP_SourceFund_Spouse").checked);
        safeCheck(form, "ThirdPP_SourceFund_Others", $("ThirdPP_SourceFund_Others").checked);
        safeSetText(form, "ThirdPP_SourceFund_Others_Write", $("ThirdPP_SourceFund_Others_Write").value);
        safeCheck(form, "ThirdPP_SourceWealth_EmployBus", $("ThirdPP_SourceWealth_EmployBus").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Invest", $("ThirdPP_SourceWealth_Invest").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Inherit", $("ThirdPP_SourceWealth_Inherit").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Savings", $("ThirdPP_SourceWealth_Savings").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Parents", $("ThirdPP_SourceWealth_Parents").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Spouse", $("ThirdPP_SourceWealth_Spouse").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Others", $("ThirdPP_SourceWealth_Others").checked);
        safeSetText(form, "ThirdPP_SourceWealth_Others_Write", $("ThirdPP_SourceWealth_Others_Write").value);

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "Filled_Credit_Card_Enrolment.pdf"; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 2500);

      } catch (err) {
        console.error(err);
        alert("PDF generation failed: " + (err.message || err));
      } finally {
        $("generate").disabled = false;
      }
    }

    function resetAll(){
      document.querySelectorAll("input, textarea").forEach(inp => {
        if (inp.type === 'checkbox' || inp.type === 'radio') inp.checked = false;
        else inp.value = '';
      });
      localStorage.clear();
      policiesContainer.innerHTML = "";
      policyCount = 0;
      addPolicyBtn.disabled = false;
      addPolicy();
      restoreSignaturePreview();
      showSaveStatus();
    }

    $("generate").addEventListener("click", fillPDF);
    $("resetAll").addEventListener("click", resetAll);

    (function restoreOnLoad(){
      const savedPolicyCount = parseInt(localStorage.getItem('policyCount')) || 1;
      policiesContainer.innerHTML = "";
      policyCount = 0;
      for (let i = 1; i <= savedPolicyCount; i++) {
        addPolicy();
      }
      
      document.querySelectorAll("input, textarea").forEach(el => {
        const saved = localStorage.getItem(el.id);
        if (saved !== null) {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = (saved === 'true');
          } else {
            el.value = saved;
          }
        }
      });
      restoreSignaturePreview();
    })();

    window.addEventListener('storage', ()=> showSaveStatus());
  </script>
</body>
</html>
