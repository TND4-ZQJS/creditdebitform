<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Credit/Debit Card Enrolment — Web Filler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin:0 0 12px 0;font-size:1.25rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
  .section h2{margin:0 0 10px 0;font-size:1.05rem}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
  }
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#999}
  button.ghost{background:transparent;border:1px solid var(--line);color:#333}
  .actions{display:flex;gap:12px;align-items:center}

  /* Header tidy alignment */
  .header-agree{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;
  }
  .header-agree input[type=checkbox]{margin:0}
  .header-agree .title{font-weight:600}
  .header-grid{
    margin-top:10px;
    display:grid;gap:10px;
    grid-template-columns: 1fr 1fr;
    align-items:start;
  }
  .header-item{
    background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px
  }
  .header-item .stack{display:flex;flex-direction:column;gap:6px;width:100%}
  .header-item .inline{display:flex;align-items:center;gap:8px}
  .header-item input[type=checkbox]{margin:0}
  .amount-wrap{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .amount-wrap label{margin:0}

  .onetime-charge-options {
    grid-column: 2 / -1;
    opacity: 0.5;
    pointer-events: none; /* Prevents interaction when dimmed */
  }

  .onetime-charge-options.active {
    opacity: 1;
    pointer-events: auto; /* Allows interaction when active */
  }

  .onetime-charge-options fieldset{
    border: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .onetime-charge-options input[type="number"]{
    width: auto;
    margin-top: 0;
  }

  .onetime-charge-options input[type="number"][disabled] {
    background-color: #f6f7f9;
    cursor: not-allowed;
  }
  
  .onetime-charge-options .row{
    align-items: center;
  }

  .onetime-charge-options .row:has(#Onetimecharge_alloutstanding:not(:checked)) .option-label {
    color: var(--muted);
  }
  .onetime-charge-options .row:has(#Onetimecharge_specific:not(:checked)) .option-label {
    color: var(--muted);
  }
  .onetime-charge-options .row:has(#Onetimecharge_specific:not(:checked)) #Onetimecharge_amt {
    opacity: 0.5;
  }

  /* Card number */
  .card-number-block .card-number-inputs{display:flex;gap:8px;margin-top:8px}
  .card-digit{width:80px;padding:8px;border-radius:10px;border:1px solid #ddd;text-align:center;font-size:1.05rem;background:#fff}
  .card-digit:focus{outline:2px solid rgba(0,122,255,0.15)}

  /* Policy grid */
  .policy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .policy{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .policy h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .policy .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .policy .remove-btn:hover{border-color:#d0d0d7}
  
  /* Relationships for policy section */
  .policy .relationships {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  .policy .relationships label {
    margin: 0;
    font-size: 0.9rem;
  }

  /* Signature */
  .sig-preview{
    border:1px solid #ddd; border-radius:10px; width:100%; height:120px;
    background:#fff; display:flex; align-items:center; justify-content:center;
    cursor:pointer; overflow:hidden;
  }
  .sig-preview img{max-width:100%; max-height:100%}

  /* Modal */
  #sigModal{ display:none; position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; }
  #sigModalContent{ background:#fff; padding:12px; border-radius:10px; display:flex; flex-direction:column; gap:10px; width:min(720px,96vw); }
  #sigCanvas{ border:1px solid #ddd; border-radius:10px; touch-action:none; display:block; }

  /* Save indicator */
  #saveStatus{
    position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
    padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
  }

  @media (max-width:900px){
    .header-grid{grid-template-columns:1fr}
    .onetime-charge-options{grid-column: 1 / -1;}
  }
  @media (max-width:720px){
    .policy-grid{grid-template-columns:1fr}
    .card-digit{width:60px}
  }
</style>
</head>
<body>
<main>
  <h1>Credit/Debit Card Enrolment — Prototype</h1>

  <section class="section header">
    <h2>Header</h2>

    <div class="header-agree">
      <input id="CCAgree" type="checkbox" />
      <div class="title">I agree for recurring credit/debit card services</div>
    </div>

    <div class="header-grid">
      <div class="header-item">
        <label class="inline">
          <input id="Onetimecharge_tick" type="checkbox" />
          <span>Request one-time charge</span>
        </label>
      </div>

      <div class="header-item onetime-charge-options">
        <fieldset>
          <div class="row">
            <label class="inline">
              <input type="radio" name="onetime_charge_option" id="Onetimecharge_alloutstanding" value="all" />
              <span class="option-label">One-time Charge for All Outstanding</span>
            </label>
          </div>
          <div class="row">
            <label class="inline">
              <input type="radio" name="onetime_charge_option" id="Onetimecharge_specific_radio" value="specific" />
              <span class="option-label">One-time Charge Amount (RM)</span>
            </label>
            <input id="Onetimecharge_amt" type="number" step="0.01" placeholder="0.00" disabled />
          </div>
        </fieldset>
      </div>
    </div>
  </section>

  <section class="section" id="sectionA">
    <h2>Section A — Policy Entries</h2>

    <div id="policiesContainer" class="policy-grid"></div>

    <div class="row">
      <button id="addPolicy">+ Add Another Policy</button>
      <small class="muted">Up to 4 policies</small>
    </div>
  </section>

  <section class="section">
    <h2>Section B - Card Details</h2>

    <label>Cardholder's Name (as in I/C)
      <input id="CardName" type="text" placeholder="AS IN I/C">
    </label>

    <div class="row">
      <label class="inline"><input name="cardType" id="CC_Tick" type="radio"> Credit Card</label>
      <label class="inline"><input name="cardType" id="DebitC_Tick" type="radio"> Debit Card</label>
    </div>

    <div class="card-number-block">
      <label>Card Number</label>
      <div class="card-number-inputs">
        <input class="card-digit" id="CardNo_1" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_2" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_3" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_4" maxlength="4" inputmode="numeric" pattern="\d*">
      </div>
      <small class="muted">Type 4 digits per box. Paste full 16-digit number — it will auto-split.</small>
    </div>

    <div class="row">
      <label style="flex:1">Expiry (Month)
        <select id="CardExpry_M_Select">
          <option value="">-- Month --</option>
        </select>
      </label>
      <label style="flex:1">Expiry (Year)
        <select id="CardExpry_Y_Select">
          <option value="">-- Year --</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label style="flex:1">Issuing Bank
        <select id="CardBank_Select">
          <option value="">-- Select Bank --</option>
          <option value="Maybank">Maybank</option>
          <option value="Public Bank">Public Bank</option>
          <option value="CIMB">CIMB</option>
          <option value="UOB">UOB</option>
          <option value="AmBank">AmBank</option>
          <option value="Hong Leong Bank">Hong Leong Bank</option>
          <option value="HSBC">HSBC</option>
          <option value="Standard Chartered">Standard Chartered</option>
          <option value="RHB">RHB</option>
          <option value="Bank Islam">Bank Islam</option>
          <option value="Bank Rakyat">Bank Rakyat</option>
          <option value="Bank Muamalat">Bank Muamalat</option>
          <option value="OCBC">OCBC</option>
          <option value="CITI">CITI</option>
          <option value="AEON Credit">AEON Credit</option>
          <option value="Bank of China">Bank of China</option>
          <option value="Alliance Bank">Alliance Bank</option>
          <option value="Bank Simpanan Nasional">Bank Simpanan Nasional</option>
        </select>
        </label>
    </div>

    <div class="row">
      <label class="inline"><input name="brand" id="Visa_Tick" type="radio"> Visa</label>
      <label class="inline"><input name="brand" id="Master_Tick" type="radio"> Master</label>
    </div>
  </section>

<section class="section" id="sectionC">
  <h2>Section C - Third Party / Source</h2>

  <label class="inline">
    <input id="ThirdPP_Yes" type="checkbox">
    <span>Payment by Third Party Payor (other than Policyowner)</span>
  </label>

  <div id="thirdPP_ic_wrap" style="display:none; margin-top:8px;">
    <label class="inline">
      <input id="ThirdPP_SubmittedNRIC" type="checkbox">
      <span>Prepare IC Copy to be submitted together with this form</span>
    </label>
  </div>

  <div id="thirdPP_fields" style="display:none; margin-top:14px;">
    <label>Third Party Payor’s Name
      <input id="ThirdPP_Name" type="text">
    </label>

    <label>Date of Birth</label>
    <div class="row">
      <select id="dob_day"></select>
      <select id="dob_month"></select>
      <input id="dob_year" type="number" min="1900" max="2100" placeholder="YYYY">
    </div>

    <label>IC No.
      <input id="ThirdPP_NIRC" type="text">
    </label>
    <label>Nationality
      <input id="ThirdPP_Nationality" type="text">
    </label>
    <label>Correspondence Address Line 1
      <input id="ThirdPP_CorrespAdd_Line1" type="text">
    </label>
    <label>Correspondence Address Line 2
      <input id="ThirdPP_CorrespAdd_Line2" type="text">
    </label>
    <label>Postcode
      <input id="ThirdPP_CorrrepAdd_Postcode" type="number">
    </label>
    <label>Country
      <input id="ThirdPP_CorrespAdd_Country" type="text">
    </label>
    <label>Email Address
      <input id="ThirdPP_Email" type="email">
    </label>
    <label>Mobile No.
      <input id="ThirdPP_Phone" type="text">
    </label>
    <label>Occupation
      <input id="ThirdPP_Occupation" type="text">
    </label>
    <label>Name of Employer
      <input id="ThirdPP_Employer" type="text">
    </label>
    <label>Nature of Business
      <input id="ThirdPP_NatureBusiness" type="text">
    </label>
    <label>Monthly Income (RM)
      <input id="ThirdPP_Income" type="number" step="0.01">
    </label>

    <h3>Source of Funds</h3>
    <label class="inline"><input id="ThirdPP_SourceFund_Self" type="checkbox"> <span>Self</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Parent" type="checkbox"> <span>Parent(s)</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Spouse" type="checkbox"> <span>Spouse</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Others" type="checkbox"> <span>Others</span></label>
    <label>If others specify
      <input id="ThirdPP_SourceFund_Others_Write" type="text">
    </label>

    <h3>Source of Wealth</h3>
    <label class="inline"><input id="ThirdPP_SourceWealth_EmployBus" type="checkbox"> <span>Employment/Business</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Invest" type="checkbox"> <span>Investment</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Inherit" type="checkbox"> <span>Inheritance</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Savings" type="checkbox"> <span>Savings</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Parents" type="checkbox"> <span>Parents</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Spouse" type="checkbox"> <span>Spouse</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Others" type="checkbox"> <span>Others</span></label>
    <label>If others specify
      <input id="ThirdPP_SourceWealth_Others_Write" type="text">
    </label>
  </div>
</section>

<section class="section" id="sectionD">
  <h2>Section D - PDPA</h2>
  <label class="inline">
    <input id="PDPA" type="checkbox">
    <span>I have read and agree to the PDPA terms</span>
  </label>
</section>

<section class="section" id="sectionE">
  <h2>Section E – Sign & Authorise</h2>

  <div class="row">
    <label style="flex:1">Policy Owner’s Name
      <div class="row" style="gap:8px;align-items:center">
        <input id="Sign_OwnerName" type="text" placeholder="AS IN I/C" style="flex:1">
        <label class="inline" title="Copy from Cardholder's Name">
          <input id="Owner_SameAsCard" type="checkbox"> <span>same as Card owner</span>
        </label>
      </div>
    </label>
    <label style="flex:1">IC No.
      <input id="Sign_OwnerNIRC" type="text" inputmode="numeric" pattern="\d*">
    </label>
  </div>

  <div class="row">
    <label style="flex:1">Signed at (State)
      <select id="Sign_State">
        <option value="">-- Select State --</option>
        <option>SELANGOR</option>
        <option>K.LUMPUR</option>
        <option>MELAKA</option>
        <option>N.SEMBILAN</option>
        <option>JOHOR</option>
        <option>PENANG</option>
        <option>PERAK</option>
        <option>KEDAH</option>
        <option>PAHANG</option>
        <option>PERLIS</option>
        <option>SARAWAK</option>
        <option>SABAH</option>
        <option>T'GANU</option>
        <option>KELANTAN</option>
      </select>
    </label>
    
    <label>Signed month
      <select id="Sign_Month">
        <option value="">-- Month --</option>
      </select>
    </label>

    <label>Signed date
      <select id="Sign_Day">
        <option value="">-- Day --</option>
      </select>
    </label>

    <label>Signed year
      <select id="Sign_Year">
        <option value="">-- Year --</option>
      </select>
    </label>
  </div>

  <h3 style="margin:8px 0">Owner’s Signature</h3>
  <div class="sig-preview" id="sigprev_owner" onclick="openSig('owner')">
    <span>Tap to Sign (Owner)</span>
  </div>
  <div class="row">
    <button id="clearSigOwner" type="button" class="secondary">Clear Owner Signature</button>
  </div>

  <div id="payor_block" style="display:none; margin-top:14px;">
    <div class="muted" style="margin-bottom:6px"><em>Fill and Sign only if Payor is not Policy Owner</em></div>

    <div class="row">
      <label style="flex:1">Payor’s Name
        <div class="row" style="gap:8px;align-items:center">
          <input id="Sign_PayorName" type="text" placeholder="AS IN I/C" style="flex:1">
          <label class="inline" title="Copy from Third Party Payor’s Name">
            <input id="Payor_SameAsThirdPP" type="checkbox"> <span>same as Third Party Payor</span>
          </label>
        </div>
      </label>
      <label style="flex:1">Payor’s IC No.
        <div class="row" style="gap:8px;align-items:center">
          <input id="Sign_PayorNIRC" type="text" inputmode="numeric" pattern="\d*" style="flex:1">
          <label class="inline" title="Copy from Third Party Payor’s IC">
            <input id="PayorIC_SameAsThirdPP" type="checkbox"> <span>same as Third Party Payor</span>
          </label>
        </div>
      </label>
    </div>

    <h3 style="margin:8px 0">Payor’s Signature</h3>
    <div class="sig-preview" id="sigprev_payor" onclick="openSig('payor')">
      <span>Tap to Sign (Payor)</span>
    </div>
    <div class="row">
      <button id="clearSigPayor" type="button" class="secondary">Clear Payor Signature</button>
    </div>
  </div>
</section>


<div id="sigModal" style="display:none; position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center;">
  <div id="sigModalContent" style="background:#fff; padding:12px; border-radius:10px; display:flex; flex-direction:column; gap:10px; width:min(720px,96vw);">
    <canvas id="sigCanvas" style="border:1px solid #ddd; border-radius:10px; touch-action:none;"></canvas>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="saveSigBtn" type="button">Done</button>
      <button id="clearSigBtn" type="button" class="secondary">Clear</button>
      <button id="cancelSigBtn" type="button" class="secondary">Cancel</button>
    </div>
  </div>
</div>

  <section class="section actions">
    <button id="generate">Generate PDF</button>
    <button id="resetAll" class="secondary">Reset All</button>
  </section>

  <footer>
    <small>Make sure <code>Credit Card Enrolment Form_LF4092_200524_fillable.pdf</code> is in the same folder.</small>
  </footer>
</main>

<div id="saveStatus">Saved</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
/* ---------- CONFIG ---------- */
const PDF_FILENAME = "Credit Card Enrolment Form_LF4092_200524_fillable.pdf";
const MAX_POLICIES = 4;

/* ---------- helpers ---------- */
function $(id){return document.getElementById(id);}
function safeSetText(form, name, text){
  try{ form.getTextField(name).setText(String(text || "")); } catch(e){ console.warn(`Field ${name} not found or failed to set text.`, e); }
}
function safeCheck(form, name, checked){
  try{ const cb = form.getCheckBox(name); if (checked) cb.check(); else cb.uncheck(); } catch(e){ console.warn(`Field ${name} not found or failed to check.`, e); }
}

/* ---------- UI Logic & Autosave ---------- */
const saveStatusEl = $("saveStatus");
function showSaveStatus(){
  saveStatusEl.style.opacity = 1;
  clearTimeout(saveStatusEl._timer);
  saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
}
function debounceSave(fn, wait=150){
  let t;
  return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
}
function saveElValue(el){
  if(!el || !el.id) return;
  localStorage.setItem(el.id, el.value);
  showSaveStatus();
}

/* One-time charge UI logic */
const onetimeChargeTick = $("Onetimecharge_tick");
const onetimeChargeOptions = document.querySelector(".onetime-charge-options");
const onetimeChargeAmtInput = $("Onetimecharge_amt");
onetimeChargeTick.addEventListener("change", ()=>{ onetimeChargeOptions.classList.toggle("active", onetimeChargeTick.checked); });
$("Onetimecharge_specific_radio").addEventListener("change", ()=>{ onetimeChargeAmtInput.disabled = !this.checked; });
$("Onetimecharge_alloutstanding").addEventListener("change", ()=>{ onetimeChargeAmtInput.disabled = this.checked; });

/* Third Party Payor UI logic */
const thirdPPTick = $("ThirdPP_Yes");
const thirdPPIcWrap = $("thirdPP_ic_wrap");
const thirdPPFields = $("thirdPP_fields");
const payorBlock = $("payor_block");
thirdPPTick.addEventListener("change", ()=>{
  thirdPPIcWrap.style.display = thirdPPTick.checked ? "block" : "none";
  payorBlock.style.display = thirdPPTick.checked ? "block" : "none";
  if (!thirdPPTick.checked) {
    $("ThirdPP_SubmittedNRIC").checked = false;
    thirdPPFields.style.display = "none";
  }
});
$("ThirdPP_SubmittedNRIC").addEventListener("change", ()=>{ thirdPPFields.style.display = $("ThirdPP_SubmittedNRIC").checked ? "block" : "none"; });

/* Same As checkboxes */
const ownerSameAsCard = $("Owner_SameAsCard");
ownerSameAsCard.addEventListener("change", ()=>{
  $("Sign_OwnerName").value = ownerSameAsCard.checked ? $("CardName").value : "";
  saveElValue($("Sign_OwnerName"));
});
const payorSameAsThirdPP = $("Payor_SameAsThirdPP");
payorSameAsThirdPP.addEventListener("change", ()=>{
  $("Sign_PayorName").value = payorSameAsThirdPP.checked ? $("ThirdPP_Name").value : "";
  saveElValue($("Sign_PayorName"));
});
const payorIcSameAsThirdPP = $("PayorIC_SameAsThirdPP");
payorIcSameAsThirdPP.addEventListener("change", ()=>{
  $("Sign_PayorNIRC").value = payorIcSameAsThirdPP.checked ? $("ThirdPP_NIRC").value : "";
  saveElValue($("Sign_PayorNIRC"));
});

/* ---------- Policies dynamic ---------- */
const policiesContainer = $("policiesContainer");
const addPolicyBtn = $("addPolicy");
let policyCount = 0;

function createPolicyEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "policy";
  wrap.dataset.index = index;
  const title = document.createElement("h3"); title.textContent = `Policy ${index}`; wrap.appendChild(title);

  const pNoLabel = document.createElement("label"); pNoLabel.textContent = "Policy No.";
  const pNoInput = document.createElement("input"); pNoInput.type="text"; pNoInput.id=`PolicyNo${index}`;
  pNoLabel.appendChild(pNoInput); wrap.appendChild(pNoLabel);

  const ownerLabel = document.createElement("label"); ownerLabel.textContent = "Insured Name";
  const ownerInput = document.createElement("input"); ownerInput.type="text"; ownerInput.id=`Insured${index}`;
  ownerLabel.appendChild(ownerInput); wrap.appendChild(ownerLabel);

  const relWrap = document.createElement("div"); relWrap.className="relationships";
  const relTitle = document.createElement("div"); relTitle.textContent = "Relationship:"; relTitle.style.fontWeight = "600"; relWrap.appendChild(relTitle);
  const rels = ["Ownself","Spouse","Children","Parent","Grandparent","Sibling","Company"];
  rels.forEach(rel=>{
    const label = document.createElement("label");
    const input = document.createElement("input");
    input.type="checkbox";
    input.name=`Relationship${index}`;
    input.value=rel;
    input.id=`Relationship${index}_${rel}`;
    label.appendChild(input);
    label.append(rel);
    relWrap.appendChild(label);
  });
  wrap.appendChild(relWrap);

  if(index>1){
    const rem=document.createElement("button"); rem.type="button"; rem.className="secondary"; rem.textContent="Remove"; rem.style.marginTop="8px";
    rem.addEventListener("click", ()=>{
      wrap.remove();
      policyCount--;
      addPolicyBtn.disabled=false;
      reorganizePolicyIndices();
      showSaveStatus();
    });
    wrap.appendChild(rem);
  }
  return wrap;
}
function addPolicy(){ if(policyCount>=MAX_POLICIES) return; policyCount++; policiesContainer.appendChild(createPolicyEntry(policyCount)); if(policyCount>=MAX_POLICIES) addPolicyBtn.disabled=true; localStorage.setItem("policyCount", policyCount); showSaveStatus(); }
function reorganizePolicyIndices(){
  const nodes = Array.from(policiesContainer.querySelectorAll(".policy"));
  policyCount = nodes.length;
  nodes.forEach((n, idx)=> {
    const newIdx = idx+1; n.dataset.index=newIdx; n.querySelector("h3").textContent=`Policy ${newIdx}`;
    n.querySelector(`[id^="PolicyNo"]`).id=`PolicyNo${newIdx}`;
    n.querySelector(`[id^="Insured"]`).id=`Insured${newIdx}`;
    const checkboxes = n.querySelectorAll(`[name^="Relationship"]`);
    checkboxes.forEach(cb=>{
      cb.name=`Relationship${newIdx}`;
      cb.id=`Relationship${newIdx}_${cb.value}`;
    });
  });
  addPolicyBtn.disabled = policyCount >= MAX_POLICIES;
  localStorage.setItem("policyCount", policyCount);
}
addPolicyBtn.addEventListener("click", addPolicy);

/* ---------- Card number inputs ---------- */
const ccDigits = [ $("CardNo_1"), $("CardNo_2"), $("CardNo_3"), $("CardNo_4") ];
ccDigits.forEach((el, idx)=>{
  el.addEventListener("input", ()=>{ el.value = el.value.replace(/\D/g,'').slice(0,4); if(el.value.length===4 && idx<ccDigits.length-1) ccDigits[idx+1].focus(); saveElValue(el); });
  el.addEventListener("keydown", (e)=>{ if(e.key==="Backspace" && el.value.length===0 && idx>0) ccDigits[idx-1].focus(); });
  el.addEventListener("paste", (e)=>{
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    const digits = paste.replace(/\D/g,'').slice(0,16).padEnd(16,' ');
    for(let i=0;i<4;i++){ ccDigits[i].value = digits.slice(i*4, i*4+4).trim(); saveElValue(ccDigits[i]); }
    for(let i=0;i<4;i++){ if(ccDigits[i].value.length<4){ ccDigits[i].focus(); break; } if(i===3) ccDigits[3].focus(); }
  });
});

/* ---------- Signature modal (shared) ---------- */
const sigModal = $("sigModal"), sigCanvas = $("sigCanvas");
const saveSigBtn = $("saveSigBtn"), clearSigBtn = $("clearSigBtn"), cancelSigBtn = $("cancelSigBtn");
const previews = { owner: $("sigprev_owner"), payor: $("sigprev_payor") };
let activeSigField = null;
let sigCtx = sigCanvas.getContext('2d');
let drawing = false;

function resizeSigCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = Math.min(window.innerWidth * 0.95, 700);
  const cssHeight = cssWidth / 3.3;
  sigCanvas.width = cssWidth * dpr;
  sigCanvas.height = cssHeight * dpr;
  sigCanvas.style.width = cssWidth + 'px';
  sigCanvas.style.height = cssHeight + 'px';
  sigCtx.setTransform(dpr,0,0,dpr,0,0);
  sigCtx.lineWidth = 2.5;
  sigCtx.lineCap = 'round';
  sigCtx.strokeStyle = '#000';
}
function openSig(field){
  activeSigField = field;
  sigModal.style.display = 'flex';
  resizeSigCanvas();
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  const saved = localStorage.getItem(field + '_sig');
  if(saved){
    const img = new Image();
    img.src = saved;
    img.onload = ()=> sigCtx.drawImage(img,0,0,sigCanvas.width/(window.devicePixelRatio||1), sigCanvas.height/(window.devicePixelRatio||1));
  }
}
function closeSig(){ sigModal.style.display = 'none'; activeSigField = null; }

sigCanvas.addEventListener('mousedown', e=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); });
sigCanvas.addEventListener('mousemove', e=>{ if(!drawing) return; sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); });
sigCanvas.addEventListener('mouseup', ()=>drawing=false);
sigCanvas.addEventListener('mouseleave', ()=>drawing=false);
sigCanvas.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(t.clientX-rect.left, t.clientY-rect.top); drawing=true; }, {passive:false});
sigCanvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.lineTo(t.clientX-rect.left, t.clientY-rect.top); sigCtx.stroke(); }, {passive:false});
sigCanvas.addEventListener('touchend', ()=>drawing=false);

saveSigBtn.addEventListener('click', ()=>{
  if(!activeSigField) return;
  const dataURL = sigCanvas.toDataURL();
  localStorage.setItem(activeSigField + '_sig', dataURL);
  previews[activeSigField].innerHTML = `<img src="${dataURL}">`;
  closeSig();
  showSaveStatus();
});
clearSigBtn.addEventListener('click', ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  localStorage.removeItem(activeSigField + '_sig');
  previews[activeSigField].innerHTML = `<span>Tap to Sign (${activeSigField==='payor'?'Payor':'Owner'})</span>`;
});
cancelSigBtn.addEventListener('click', closeSig);

/* Clear preview buttons */
$("clearSigOwner").addEventListener("click", ()=>{
  localStorage.removeItem('owner_sig');
  previews.owner.innerHTML = `<span>Tap to Sign (Owner)</span>`;
});
$("clearSigPayor").addEventListener("click", ()=>{
  localStorage.removeItem('payor_sig');
  previews.payor.innerHTML = `<span>Tap to Sign (Payor)</span>`;
});

/* On load - restore previews if saved */
function restoreSignaturePreviews(){
  const o = localStorage.getItem('owner_sig');
  const p = localStorage.getItem('payor_sig');
  if(o) previews.owner.innerHTML = `<img src="${o}">`;
  if(p) previews.payor.innerHTML = `<img src="${p}">`;
}

/* ---------- Expiry date selectors ---------- */
(function populateDateSelectors(){
  const cardMonthSel = $("CardExpry_M_Select");
  const cardYearSel = $("CardExpry_Y_Select");
  const dobDay = $("dob_day");
  const dobMonth = $("dob_month");
  const signMonth = $("Sign_Month");
  const signDay = $("Sign_Day");
  const signYear = $("Sign_Year");
  const months = ["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  for(let i=1;i<=12;i++) {
    const val = String(i).padStart(2,'0');
    cardMonthSel.innerHTML += `<option value="${val}">${months[i-1]}</option>`;
    dobMonth.innerHTML += `<option value="${val}">${months[i-1]}</option>`;
    signMonth.innerHTML += `<option value="${months[i-1]}">${months[i-1]}</option>`;
  }
  const currentYear = new Date().getFullYear();
  for(let y=currentYear;y<=currentYear+15;y++) cardYearSel.innerHTML += `<option>${y}</option>`;
  for(let i=1;i<=31;i++) {
    const val = String(i).padStart(2,'0');
    dobDay.innerHTML += `<option value="${val}">${i}</option>`;
    signDay.innerHTML += `<option value="${val}">${i}</option>`;
  }
  for(let y=currentYear;y>=currentYear-100;y--) signYear.innerHTML += `<option>${y}</option>`;
})();

/* ---------- Fill PDF ---------- */
async function fillPDF(){
  try {
    $("generate").disabled = true;

    const res = await fetch(PDF_FILENAME);
    if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
    const bytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(bytes);
    const form = pdfDoc.getForm();

    // Header
    safeCheck(form, "CCAgree", $("CCAgree").checked);
    safeCheck(form, "Onetimecharge_tick", $("Onetimecharge_tick").checked);
    if($("Onetimecharge_tick").checked){
      if($("Onetimecharge_alloutstanding").checked) {
        safeCheck(form, "Onetimecharge_alloutstanding", true);
        safeSetText(form, "Onetimecharge_amt", "");
      } else if ($("Onetimecharge_specific_radio").checked) {
        safeCheck(form, "Onetimecharge_alloutstanding", false);
        safeSetText(form, "Onetimecharge_amt", $("Onetimecharge_amt").value || "");
      }
    } else {
      safeCheck(form, "Onetimecharge_alloutstanding", false);
      safeSetText(form, "Onetimecharge_amt", "");
    }

    // Section A - Policies
    const rows = Array.from(policiesContainer.querySelectorAll(".policy"));
    for(let i=1; i<=MAX_POLICIES; i++){
      if(rows[i-1]){
        const row = rows[i-1];
        safeSetText(form, `PolicyNo${i}`, row.querySelector(`[id^="PolicyNo"]`).value);
        safeSetText(form, `Insured${i}`, row.querySelector(`[id^="Insured"]`).value);
        const selectedRel = row.querySelector(`[name="Relationship${i}"]:checked`);
        const relationships = ["Ownself","Spouse","Children","Parent","Grandparent","Sibling","Company"];
        relationships.forEach(rel => safeCheck(form, `Relationship${i}_${rel}`, false));
        if(selectedRel) safeCheck(form, `Relationship${i}_${selectedRel.value}`, true);
      } else {
        safeSetText(form, `PolicyNo${i}`, "");
        safeSetText(form, `Insured${i}`, "");
      }
    }

    // Section B - Card Details
    safeSetText(form, "CardName", $("CardName").value);
    safeCheck(form, "CC_Tick", $("CC_Tick").checked);
    safeCheck(form, "DebitC_Tick", $("DebitC_Tick").checked);
    
    const cardNum = ccDigits.map(d=>d.value).join("").replace(/\s/g,'');
    for(let i=0; i<16; i++) {
        safeSetText(form, `CardNo_${i+1}`, cardNum[i] || "");
    }

    const expMonth = $("CardExpry_M_Select").value;
    const expYear = $("CardExpry_Y_Select").value;
    safeSetText(form, "CardExpry_M1", expMonth.slice(0,1));
    safeSetText(form, "CardExpry_M2", expMonth.slice(1,2));
    safeSetText(form, "CardExpry_Y1", expYear.slice(-2, -1));
    safeSetText(form, "CardExpry_Y2", expYear.slice(-1));

    safeSetText(form, "CardBank", $("CardBank_Select").value);
    safeCheck(form, "Visa_Tick", $("Visa_Tick").checked);
    safeCheck(form, "Master_Tick", $("Master_Tick").checked);

    // Section C - Third Party
    safeCheck(form, "ThirdPP_Yes", $("ThirdPP_Yes").checked);
    if ($("ThirdPP_Yes").checked) {
      safeCheck(form, "ThirdPP_SubmittedNRIC", $("ThirdPP_SubmittedNRIC").checked);
      if ($("ThirdPP_SubmittedNRIC").checked) {
        safeSetText(form, "ThirdPP_Name", $("ThirdPP_Name").value);
        safeSetText(form, "Text28", $("dob_day").value);
        safeSetText(form, "Text29", $("dob_month").value);
        safeSetText(form, "Text30", $("dob_year").value);
        safeSetText(form, "ThirdPP_NIRC", $("ThirdPP_NIRC").value);
        safeSetText(form, "ThirdPP_Nationality", $("ThirdPP_Nationality").value);
        safeSetText(form, "ThirdPP_CorrespAdd_Line1", $("ThirdPP_CorrespAdd_Line1").value);
        safeSetText(form, "ThirdPP_CorrespAdd_Line2", $("ThirdPP_CorrespAdd_Line2").value);
        safeSetText(form, "ThirdPP_CorrrepAdd_Postcode", $("ThirdPP_CorrrepAdd_Postcode").value);
        safeSetText(form, "ThirdPP_CorrespAdd_Country", $("ThirdPP_CorrespAdd_Country").value);
        safeSetText(form, "ThirdPP_Email", $("ThirdPP_Email").value);
        safeSetText(form, "ThirdPP_Phone", $("ThirdPP_Phone").value);
        safeSetText(form, "ThirdPP_Occupation", $("ThirdPP_Occupation").value);
        safeSetText(form, "ThirdPP_Employer", $("ThirdPP_Employer").value);
        safeSetText(form, "ThirdPP_NatureBusiness", $("ThirdPP_NatureBusiness").value);
        safeSetText(form, "ThirdPP_Income", $("ThirdPP_Income").value);

        safeCheck(form, "ThirdPP_SourceFund_Self", $("ThirdPP_SourceFund_Self").checked);
        safeCheck(form, "ThirdPP_SourceFund_Parent", $("ThirdPP_SourceFund_Parent").checked);
        safeCheck(form, "ThirdPP_SourceFund_Spouse", $("ThirdPP_SourceFund_Spouse").checked);
        safeCheck(form, "ThirdPP_SourceFund_Others", $("ThirdPP_SourceFund_Others").checked);
        safeSetText(form, "ThirdPP_SourceFund_Others_Write", $("ThirdPP_SourceFund_Others_Write").value);
        
        safeCheck(form, "ThirdPP_SourceWealth_EmployBus", $("ThirdPP_SourceWealth_EmployBus").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Invest", $("ThirdPP_SourceWealth_Invest").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Inherit", $("ThirdPP_SourceWealth_Inherit").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Savings", $("ThirdPP_SourceWealth_Savings").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Parents", $("ThirdPP_SourceWealth_Parents").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Spouse", $("ThirdPP_SourceWealth_Spouse").checked);
        safeCheck(form, "ThirdPP_SourceWealth_Others", $("ThirdPP_SourceWealth_Others").checked);
        safeSetText(form, "ThirdPP_SourceWealth_Others_Write", $("ThirdPP_SourceWealth_Others_Write").value);
      }
    }

    // Section D - PDPA
    safeCheck(form, "PDPA", $("PDPA").checked);

    // Section E - Signatures
    safeSetText(form, "Sign_OwnerName", $("Sign_OwnerName").value);
    safeSetText(form, "Sign_OwnerNIRC", $("Sign_OwnerNIRC").value);
    safeSetText(form, "Sign_State", $("Sign_State").value);
    safeSetText(form, "Sign_Month", $("Sign_Month").value);
    safeSetText(form, "Sign_Date", $("Sign_Day").value);
    safeSetText(form, "Sign_Year", $("Sign_Year").value);
    safeSetText(form, "Sign_PayorName", $("Sign_PayorName").value);
    safeSetText(form, "Sign_PayorNIRC", $("Sign_PayorNIRC").value);

    // Embed signatures on page 2 (index 1) - Adjust coordinates as needed
    const pages = pdfDoc.getPages();
    const pageForSign = pages[1];
    const ownerSig = localStorage.getItem('owner_sig');
    const payorSig = localStorage.getItem('payor_sig');
    const sigWidth = 160, sigHeight = 50;
    
    if(ownerSig){
      try{
        const pngBytes = await fetch(ownerSig).then(r=>r.arrayBuffer());
        const png = await pdfDoc.embedPng(pngBytes);
        // Adjust these coordinates to place the owner's signature correctly
        pageForSign.drawImage(png, { x: 80, y: 150, width: sigWidth, height: sigHeight });
      }catch(e){ console.warn("Owner signature embed failed:", e); }
    }
    if(payorSig){
      try{
        const pngBytes2 = await fetch(payorSig).then(r=>r.arrayBuffer());
        const png2 = await pdfDoc.embedPng(pngBytes2);
        // Adjust these coordinates to place the payor's signature correctly
        pageForSign.drawImage(png2, { x: 300, y: 150, width: sigWidth, height: sigHeight });
      }catch(e){ console.warn("Payor signature embed failed:", e); }
    }

    // Save & download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "Filled_Credit_Card_Enrolment.pdf"; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2500);

  } catch (err) {
    console.error(err);
    alert("PDF generation failed: " + (err.message || err));
  } finally {
    $("generate").disabled = false;
  }
}

/* ---------- Reset All ---------- */
function resetAll(){
  document.querySelectorAll("input").forEach(inp=>{ if(inp.type==='checkbox' || inp.type==='radio') inp.checked=false; else inp.value=''; });
  document.querySelectorAll("select").forEach(s=> s.selectedIndex = 0);
  localStorage.clear();
  policiesContainer.innerHTML = ""; policyCount = 0; addPolicyBtn.disabled=false; addPolicy();
  restoreSignaturePreviews();
}

/* ---------- On load ---------- */
(function setup(){
  const savedPolicyCount = localStorage.getItem("policyCount");
  if(savedPolicyCount){
    for(let i=0; i<savedPolicyCount; i++) addPolicy();
  } else {
    addPolicy();
  }
  
  document.querySelectorAll("input,select,textarea").forEach(el=>{
    const saved = localStorage.getItem(el.id);
    if(saved !== null) el.value = saved;
    el.addEventListener("input", debounceSave(()=> saveElValue(el)));
    if(el.type === 'checkbox' || el.type === 'radio'){
      el.addEventListener("change", debounceSave(()=> saveElValue(el)));
    }
  });

  restoreSignaturePreviews();
  
  // Trigger initial UI states
  onetimeChargeTick.dispatchEvent(new Event('change'));
  thirdPPTick.dispatchEvent(new Event('change'));
})();

window.addEventListener('storage', ()=> showSaveStatus());
</script>
</body>
</html>
