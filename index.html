<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Credit/Debit Card Enrolment — Web Filler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin:0 0 12px 0;font-size:1.25rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
  .section h2{margin:0 0 10px 0;font-size:1.05rem}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
  }
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#999}
  button.ghost{background:transparent;border:1px solid var(--line);color:#333}
  .actions{display:flex;gap:12px;align-items:center}

  /* Header tidy alignment */
  .header-agree{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;
  }
  .header-agree input[type=checkbox]{margin:0}
  .header-agree .title{font-weight:600}
  .header-grid{
    margin-top:10px;
    display:grid;gap:10px;
    grid-template-columns: 1fr 1fr;
    align-items:start;
  }
  .header-item{
    background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px
  }
  .header-item .stack{display:flex;flex-direction:column;gap:6px;width:100%}
  .header-item .inline{display:flex;align-items:center;gap:8px}
  .header-item input[type=checkbox]{margin:0}
  .amount-wrap{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .amount-wrap label{margin:0}

  .onetime-charge-options {
    grid-column: 2 / -1;
    opacity: 0.5;
    pointer-events: none; /* Prevents interaction when dimmed */
  }

  .onetime-charge-options.active {
    opacity: 1;
    pointer-events: auto; /* Allows interaction when active */
  }

  .onetime-charge-options fieldset{
    border: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .onetime-charge-options input[type="number"]{
    width: auto;
    margin-top: 0;
  }

  .onetime-charge-options input[type="number"][disabled] {
    background-color: #f6f7f9;
    cursor: not-allowed;
  }
  
  .onetime-charge-options .row{
    align-items: center;
  }

  .onetime-charge-options .row:has(#Onetimecharge_alloutstanding:not(:checked)) .option-label {
    color: var(--muted);
  }
  .onetime-charge-options .row:has(#Onetimecharge_specific:not(:checked)) .option-label {
    color: var(--muted);
  }
  .onetime-charge-options .row:has(#Onetimecharge_specific:not(:checked)) #Onetimecharge_amt {
    opacity: 0.5;
  }

  /* Card number */
  .card-number-block .card-number-inputs{display:flex;gap:8px;margin-top:8px}
  .card-digit{width:80px;padding:8px;border-radius:10px;border:1px solid #ddd;text-align:center;font-size:1.05rem;background:#fff}
  .card-digit:focus{outline:2px solid rgba(0,122,255,0.15)}

  /* Policy grid */
  .policy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .policy{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .policy h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .policy .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .policy .remove-btn:hover{border-color:#d0d0d7}

  /* Signature */
  canvas{width:100%;height:150px;border-radius:10px;border:1px solid #ddd;background:#fff}

  /* Save indicator */
  #saveStatus{
    position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
    padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
  }

  @media (max-width:900px){
    .header-grid{grid-template-columns:1fr}
    .onetime-charge-options{grid-column: 1 / -1;}
  }
  @media (max-width:720px){
    .policy-grid{grid-template-columns:1fr}
    .card-digit{width:60px}
  }

  .sig-preview{
  border:1px solid #ddd; border-radius:10px; width:100%; height:120px;
  background:#fff; display:flex; align-items:center; justify-content:center;
  cursor:pointer; overflow:hidden;
}
.sig-preview img{max-width:100%; max-height:100%}
</style>
</head>
<body>
<main>
  <h1>Credit/Debit Card Enrolment — Prototype</h1>

  <section class="section header">
    <h2>Header</h2>

    <div class="header-agree">
      <input id="CCAgree" type="checkbox" />
      <div class="title">I agree for recurring credit/debit card services</div>
    </div>

    <div class="header-grid">
      <div class="header-item">
        <label class="inline">
          <input id="Onetimecharge_tick" type="checkbox" />
          <span>Request one-time charge</span>
        </label>
      </div>

      <div class="header-item onetime-charge-options">
        <fieldset>
          <div class="row">
            <label class="inline">
              <input type="radio" name="onetime_charge_option" id="Onetimecharge_alloutstanding" value="all" />
              <span class="option-label">One-time Charge for All Outstanding</span>
            </label>
          </div>
          <div class="row">
            <label class="inline">
              <input type="radio" name="onetime_charge_option" id="Onetimecharge_specific" value="specific" />
              <span class="option-label">One-time Charge Amount (RM)</span>
            </label>
            <input id="Onetimecharge_amt" type="number" step="0.01" placeholder="0.00" disabled />
          </div>
        </fieldset>
      </div>
    </div>
  </section>

  <section class="section" id="sectionA">
    <h2>Section A — Policy Entries</h2>

    <div id="policiesContainer" class="policy-grid"></div>

    <div class="row">
      <button id="addPolicy">+ Add Another Policy</button>
      <small class="muted">Up to 4 policies</small>
    </div>
  </section>

  <section class="section">
    <h2>Section B - Card Details</h2>

    <label>Cardholder's Name (as in I/C)
      <input id="CardName" type="text" placeholder="AS IN I/C">
    </label>

    <div class="row">
      <label class="inline"><input name="cardType" id="CC_Tick" type="radio"> Credit Card</label>
      <label class="inline"><input name="cardType" id="DebitC_Tick" type="radio"> Debit Card</label>
    </div>

    <div class="card-number-block">
      <label>Card Number</label>
      <div class="card-number-inputs">
        <input class="card-digit" id="CardNo_1" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_2" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_3" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_4" maxlength="4" inputmode="numeric" pattern="\d*">
      </div>
      <small class="muted">Type 4 digits per box. Paste full 16-digit number — it will auto-split.</small>
    </div>

    <div class="row">
      <label style="flex:1">Expiry (Month)
        <select id="CardExpry_M_Select">
          <option value="">-- Month --</option>
        </select>
      </label>
      <label style="flex:1">Expiry (Year)
        <select id="CardExpry_Y_Select">
          <option value="">-- Year --</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label style="flex:1">Issuing Bank
        <select id="CardBank_Select">
          <option value="">-- Select Bank --</option>
        </select>
        </label>
    </div>

    <div class="row">
      <label class="inline"><input name="brand" id="Visa_Tick" type="radio"> Visa</label>
      <label class="inline"><input name="brand" id="Master_Tick" type="radio"> Master</label>
    </div>
  </section>

<section class="section" id="sectionC">
  <h2>Section C - Third Party / Source</h2>

  <!-- Step 1 -->
  <label class="inline">
    <input id="ThirdPP_Yes" type="checkbox">
    <span>Payment by Third Party Payor (other than Policyowner)</span>
  </label>

  <!-- Step 2 (hidden until Step 1 is checked) -->
  <div id="thirdPP_ic_wrap" style="display:none; margin-top:8px;">
    <label class="inline">
      <input id="ThirdPP_SubmittedNRIC" type="checkbox">
      <span>Prepare IC Copy to be submitted together with this form</span>
    </label>
  </div>

  <!-- Step 3 fields (hidden until Step 2 is checked) -->
  <div id="thirdPP_fields" style="display:none; margin-top:14px;">
    <label>Third Party Payor’s Name
      <input id="ThirdPP_Name" type="text">
    </label>

    <label>Date of Birth</label>
    <div class="row">
      <select id="Text28"></select>
      <select id="Text29"></select>
      <input id="Text30" type="number" min="1900" max="2100" placeholder="YYYY">
    </div>

    <label>IC No.
      <input id="ThirdPP_NIRC" type="text">
    </label>
    <label>Nationality
      <input id="ThirdPP_Nationality" type="text">
    </label>
    <label>Correspondence Address Line 1
      <input id="ThirdPP_CorrespAdd_Line1" type="text">
    </label>
    <label>Correspondence Address Line 2
      <input id="ThirdPP_CorrespAdd_Line2" type="text">
    </label>
    <label>Postcode
      <input id="ThirdPP_CorrrepAdd_Postcode" type="number">
    </label>
    <label>Country
      <input id="ThirdPP_CorrespAdd_Country" type="text">
    </label>
    <label>Email Address
      <input id="ThirdPP_Email" type="email">
    </label>
    <label>Mobile No.
      <input id="ThirdPP_Phone" type="text">
    </label>
    <label>Occupation
      <input id="ThirdPP_Occupation" type="text">
    </label>
    <label>Name of Employer
      <input id="ThirdPP_Employer" type="text">
    </label>
    <label>Nature of Business
      <input id="ThirdPP_NatureBusiness" type="text">
    </label>
    <label>Monthly Income (RM)
      <input id="ThirdPP_Income" type="number" step="0.01">
    </label>

    <h3>Source of Funds</h3>
    <label class="inline"><input id="ThirdPP_SourceFund_Self" type="checkbox"> <span>Self</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Parent" type="checkbox"> <span>Parent(s)</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Spouse" type="checkbox"> <span>Spouse</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Others" type="checkbox"> <span>Others</span></label>
    <label>If others specify
      <input id="ThirdPP_SourceFund_Others_Write" type="text">
    </label>

    <h3>Source of Wealth</h3>
    <label class="inline"><input id="ThirdPP_SourceWealth_EmployBus" type="checkbox"> <span>Employment/Business</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Invest" type="checkbox"> <span>Investment</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Inherit" type="checkbox"> <span>Inheritance</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Savings" type="checkbox"> <span>Savings</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Parents" type="checkbox"> <span>Parents</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Spouse" type="checkbox"> <span>Spouse</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Others" type="checkbox"> <span>Others</span></label>
    <label>If others specify
      <input id="ThirdPP_SourceWealth_Others_Write" type="text">
    </label>
  </div>
</section>

<!-- Section D PDPA -->
<section class="section" id="sectionD">
  <h2>Section D - PDPA</h2>
  <label class="inline">
    <input id="PDPA" type="checkbox">
    <span>I have read and agree to the PDPA terms</span>
  </label>
</section>

<section class="section" id="sectionE">
  <h2>Section E – Sign & Authorise</h2>

  <div class="row">
    <label style="flex:1">Policy Owner’s Name
      <div class="row" style="gap:8px;align-items:center">
        <input id="Sign_OwnerName" type="text" placeholder="AS IN I/C" style="flex:1">
        <label class="inline" title="Copy from Cardholder's Name">
          <input id="Owner_SameAsCard" type="checkbox"> <span>same as Card owner</span>
        </label>
      </div>
    </label>
    <label style="flex:1">IC No.
      <input id="Sign_OwnerNIRC" type="text" inputmode="numeric" pattern="\d*">
    </label>
  </div>

  <div class="row">
    <label style="flex:1">Signed at (State)
      <select id="Sign_State">
        <option value="">-- Select State --</option>
        <option>SELANGOR</option>
        <option>K.LUMPUR</option>
        <option>MELAKA</option>
        <option>N.SEMBILAN</option>
        <option>JOHOR</option>
        <option>PENANG</option>
        <option>PERAK</option>
        <option>KEDAH</option>
        <option>PAHANG</option>
        <option>PERLIS</option>
        <option>SARAWAK</option>
        <option>SABAH</option>
        <option>T'GANU</option>
        <option>KELANTAN</option>
      </select>
    </label>

    <label>Signed date
      <select id="Sign_Day">
        <option value="">-- Day --</option>
      </select>
    </label>

    <label>Signed year
      <select id="Sign_Year">
        <option value="">-- Year --</option>
      </select>
    </label>
  </div>

  <h3 style="margin:8px 0">Owner’s Signature</h3>
  <div class="sig-preview" id="sigprev_owner" onclick="openSig('owner')">
    <span>Tap to Sign (Owner)</span>
  </div>
  <div class="row">
    <button id="clearSigOwner" type="button" class="secondary">Clear Owner Signature</button>
  </div>

  <div id="payor_block" style="display:none; margin-top:14px;">
    <div class="muted" style="margin-bottom:6px"><em>Fill and Sign only if Payor is not Policy Owner</em></div>

    <div class="row">
      <label style="flex:1">Payor’s Name
        <div class="row" style="gap:8px;align-items:center">
          <input id="Sign_PayorName" type="text" placeholder="AS IN I/C" style="flex:1">
          <label class="inline" title="Copy from Third Party Payor’s Name">
            <input id="Payor_SameAsThirdPP" type="checkbox"> <span>same as Third Party Payor</span>
          </label>
        </div>
      </label>
      <label style="flex:1">Payor’s IC No.
        <div class="row" style="gap:8px;align-items:center">
          <input id="Sign_PayorNIRC" type="text" inputmode="numeric" pattern="\d*" style="flex:1">
          <label class="inline" title="Copy from Third Party Payor’s IC">
            <input id="PayorIC_SameAsThirdPP" type="checkbox"> <span>same as Third Party Payor</span>
          </label>
        </div>
      </label>
    </div>

    <h3 style="margin:8px 0">Payor’s Signature</h3>
    <div class="sig-preview" id="sigprev_payor" onclick="openSig('payor')">
      <span>Tap to Sign (Payor)</span>
    </div>
    <div class="row">
      <button id="clearSigPayor" type="button" class="secondary">Clear Payor Signature</button>
    </div>
  </div>
</section>


<!-- Shared signature modal (re-usable for owner & payor) -->
<div id="sigModal" style="display:none; position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center;">
  <div id="sigModalContent" style="background:#fff; padding:12px; border-radius:10px; display:flex; flex-direction:column; gap:10px; width:min(720px,96vw);">
    <canvas id="sigCanvas" style="border:1px solid #ddd; border-radius:10px; touch-action:none;"></canvas>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="saveSigBtn" type="button">Done</button>
      <button id="clearSigBtn" type="button" class="secondary">Clear</button>
      <button id="cancelSigBtn" type="button" class="secondary">Cancel</button>
    </div>
  </div>
</div>

  <section class="section actions">
    <button id="generate">Generate PDF</button>
    <button id="resetAll" class="secondary">Reset All</button>
  </section>

  <footer>
    <small>Make sure <code>Credit Card Enrolment Form_LF4092_200524_fillable.pdf</code> is in the same folder.</small>
  </footer>
</main>

<div id="saveStatus">Saved</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
/* ---------- CONFIG ---------- */
const PDF_FILENAME = "Zero Interest Easy Payment Plan Form_LF1739_fillable.pdf";
const MAX_POLICIES = 5;

/* ---------- helpers ---------- */
function $(id){return document.getElementById(id);}
function safeSetText(form, name, text){
  try{ form.getTextField(name).setText(String(text || "")); } catch(e){}
}
function safeCheck(form, name, checked){
  try{ const cb = form.getCheckBox(name); if (checked) cb.check(); else cb.uncheck(); } catch(e){}
}
function getCorrectMonthValue(monthName){
  const months = ["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  const index = months.indexOf(monthName.toUpperCase());
  return index !== -1 ? String(index+1).padStart(2,'0') : "";
}

/* ---------- Policies dynamic (unchanged) ---------- */
const policiesContainer = $("policiesContainer");
const addPolicyBtn = $("addPolicy");
let policyCount = 0;

function createPolicyEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "policy";
  wrap.dataset.index = index;
  const title = document.createElement("h3"); title.textContent = `Policy ${index}`; wrap.appendChild(title);

  const pNoLabel = document.createElement("label"); pNoLabel.textContent = "Policy No.";
  const pNoInput = document.createElement("input"); pNoInput.type="text"; pNoInput.id=`Paymentfor_PolicyNo${index}`; pNoInput.placeholder=`Paymentfor_PolicyNo${index}`;
  pNoLabel.appendChild(pNoInput); wrap.appendChild(pNoLabel);

  const ownerLabel = document.createElement("label"); ownerLabel.textContent = "Owner Name";
  const ownerInput = document.createElement("input"); ownerInput.type="text"; ownerInput.id=`Paymentfor_PolicyNo${index}_OwnerName`; ownerInput.placeholder=`Paymentfor_PolicyNo${index}_OwnerName`;
  ownerLabel.appendChild(ownerInput); wrap.appendChild(ownerLabel);

  const relLabel = document.createElement("label"); relLabel.textContent = "Relationship";
  const relSelect = document.createElement("select"); relSelect.id=`Paymentfor_PolicyNo${index}_Relationship`;
  ["","Ownself","Spouse","Children","Parents","Grandparents","Siblings","Employer/Employee"].forEach(opt=>{
    const o=document.createElement("option"); o.value=opt; o.textContent=opt===""?"-- choose --":opt; relSelect.appendChild(o);
  });
  relLabel.appendChild(relSelect); wrap.appendChild(relLabel);

  const premLabel = document.createElement("label"); premLabel.textContent = "First Premium (RM)";
  const premInput = document.createElement("input"); premInput.type="text"; premInput.id=`Paymentfor_PolicyNo${index}_FirstPremium`; premInput.placeholder="e.g. 1200.00";
  premLabel.appendChild(premInput); wrap.appendChild(premLabel);

  if(index>1){
    const rem=document.createElement("button"); rem.type="button"; rem.className="secondary"; rem.textContent="Remove"; rem.style.marginTop="8px";
    rem.addEventListener("click", ()=>{
      wrap.remove();
      policyCount--;
      addPolicyBtn.disabled=false;
      reorganizePolicyIndices();
      showSaveStatus();
      localStorage.removeItem("policies_data_" + index);
    });
    wrap.appendChild(rem);
  }
  return wrap;
}
function addPolicy(){ if(policyCount>=MAX_POLICIES) return; policyCount++; policiesContainer.appendChild(createPolicyEntry(policyCount)); if(policyCount>=MAX_POLICIES) addPolicyBtn.disabled=true; localStorage.setItem("policyCount", policyCount); showSaveStatus(); }
function reorganizePolicyIndices(){
  const nodes = Array.from(policiesContainer.querySelectorAll(".policy"));
  policyCount = nodes.length;
  nodes.forEach((n, idx)=> {
    const newIdx = idx+1; n.dataset.index=newIdx; n.querySelector("h3").textContent=`Policy ${newIdx}`;
    const pNo = n.querySelector(`[id^="Paymentfor_PolicyNo"]`); if(pNo){ pNo.id=`Paymentfor_PolicyNo${newIdx}`; pNo.placeholder=`Paymentfor_PolicyNo${newIdx}`;}
    const owner = n.querySelector(`[id^="Paymentfor_PolicyNo"][id$="_OwnerName"]`); if(owner){ owner.id=`Paymentfor_PolicyNo${newIdx}_OwnerName`; owner.placeholder=`Paymentfor_PolicyNo${newIdx}_OwnerName`;}
    const rel = n.querySelector("select"); if(rel) rel.id=`Paymentfor_PolicyNo${newIdx}_Relationship`;
    const prem = n.querySelector(`[id^="Paymentfor_PolicyNo"][id$="_FirstPremium"]`); if(prem){ prem.id=`Paymentfor_PolicyNo${newIdx}_FirstPremium`; prem.placeholder=`Paymentfor_PolicyNo${newIdx}_FirstPremium`;}
  });
  addPolicyBtn.disabled = policyCount >= MAX_POLICIES;
  localStorage.setItem("policyCount", policyCount);
}

/* ---------- Credit card inputs ---------- */
const ccDigits = [ $("CC_1"), $("CC_2"), $("CC_3"), $("CC_4") ];
ccDigits.forEach((el, idx)=>{
  el.addEventListener("input", ()=>{ el.value = el.value.replace(/\D/g,'').slice(0,4); if(el.value.length===4 && idx<ccDigits.length-1) ccDigits[idx+1].focus(); saveElValue(el); });
  el.addEventListener("keydown", (e)=>{ if(e.key==="Backspace" && el.value.length===0 && idx>0) ccDigits[idx-1].focus(); });
  el.addEventListener("paste", (e)=>{
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    const digits = paste.replace(/\D/g,'').slice(0,16).padEnd(16,' ');
    for(let i=0;i<4;i++){ ccDigits[i].value = digits.slice(i*4, i*4+4).trim(); saveElValue(ccDigits[i]); }
    for(let i=0;i<4;i++){ if(ccDigits[i].value.length<4){ ccDigits[i].focus(); break; } if(i===3) ccDigits[3].focus(); }
  });
});

/* ---------- Signature modal (shared) ---------- */
const sigModal = $("sigModal"), sigCanvas = $("sigCanvas"), sigModalContent = $("sigModalContent");
const saveSigBtn = $("saveSigBtn"), clearSigBtn = $("clearSigBtn"), cancelSigBtn = $("cancelSigBtn");
const previews = { cardholder: $("preview_cardholder"), witness: $("preview_witness") };
let activeSigField = null;
let sigCtx = sigCanvas.getContext('2d');
let drawing = false;

function resizeSigCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = Math.min(window.innerWidth * 0.95, 700);
  const cssHeight = cssWidth / 3.3;
  sigCanvas.width = cssWidth * dpr;
  sigCanvas.height = cssHeight * dpr;
  sigCanvas.style.width = cssWidth + 'px';
  sigCanvas.style.height = cssHeight + 'px';
  sigCtx.setTransform(dpr,0,0,dpr,0,0);
  sigCtx.lineWidth = 2.5;
  sigCtx.lineCap = 'round';
  sigCtx.strokeStyle = '#000';
}
function openSig(field){
  activeSigField = field;
  sigModal.style.display = 'flex';
  resizeSigCanvas();
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  const saved = localStorage.getItem(field + '_sig');
  if(saved){
    const img = new Image();
    img.src = saved;
    img.onload = ()=> sigCtx.drawImage(img,0,0,sigCanvas.width/(window.devicePixelRatio||1), sigCanvas.height/(window.devicePixelRatio||1));
  }
}
function closeSig(){ sigModal.style.display = 'none'; activeSigField = null; }

sigCanvas.addEventListener('mousedown', e=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); });
sigCanvas.addEventListener('mousemove', e=>{ if(!drawing) return; sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); });
sigCanvas.addEventListener('mouseup', ()=>drawing=false);
sigCanvas.addEventListener('mouseleave', ()=>drawing=false);
sigCanvas.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(t.clientX-rect.left, t.clientY-rect.top); drawing=true; }, {passive:false});
sigCanvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.lineTo(t.clientX-rect.left, t.clientY-rect.top); sigCtx.stroke(); }, {passive:false});
sigCanvas.addEventListener('touchend', ()=>drawing=false);

saveSigBtn.addEventListener('click', ()=>{
  if(!activeSigField) return;
  const dataURL = sigCanvas.toDataURL();
  localStorage.setItem(activeSigField + '_sig', dataURL);
  previews[activeSigField].innerHTML = `<img src="${dataURL}">`;
  closeSig();
  showSaveStatus();
});
clearSigBtn.addEventListener('click', ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  localStorage.removeItem(activeSigField + '_sig');
  previews[activeSigField].innerHTML = `<span>Tap to Sign (${activeSigField==='witness'?'Witness':'Cardholder'})</span>`;
});
cancelSigBtn.addEventListener('click', closeSig);

/* Clear preview buttons */
$("clearPreviewCardholder").addEventListener("click", ()=>{
  localStorage.removeItem('cardholder_sig');
  previews.cardholder.innerHTML = `<span>Tap to Sign (Cardholder)</span>`;
});
$("clearPreviewWitness").addEventListener("click", ()=>{
  localStorage.removeItem('witness_sig');
  previews.witness.innerHTML = `<span>Tap to Sign (Witness)</span>`;
});

/* On load - restore previews if saved */
function restoreSignaturePreviews(){
  const c = localStorage.getItem('cardholder_sig');
  const w = localStorage.getItem('witness_sig');
  if(c) previews.cardholder.innerHTML = `<img src="${c}">`;
  if(w) previews.witness.innerHTML = `<img src="${w}">`;
}
restoreSignaturePreviews();

/* ---------- Signed date selects (same as amendment filler) ---------- */
(function populateDateSelectors(){
  const daySel = $("Signed_Day");
  for(let i=1;i<=31;i++) daySel.innerHTML += `<option>${i}</option>`;
  const monthSel = $("Signed_Month");
  const months = ["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  months.forEach(m=> monthSel.innerHTML += `<option>${m}</option>`);
  const yearSel = $("Signed_Year");
  const current = new Date().getFullYear();
  for(let y=current;y>=current-5;y--) yearSel.innerHTML += `<option>${y}</option>`;
})();

/* ---------- localStorage autosave + restore ---------- */
const saveStatusEl = $("saveStatus");
let saveTimer = null;
function showSaveStatus(){
  saveStatusEl.style.opacity = 1;
  clearTimeout(saveStatusEl._timer);
  saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
}

/* Debounced save wrapper */
function debounceSave(fn, wait=150){
  let t;
  return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
}

/* Save an element's value to localStorage (for inputs & selects) */
function saveElValue(el){
  if(!el || !el.id) return;
  localStorage.setItem(el.id, el.value);
  showSaveStatus();
}

/* Initialize inputs/selects/textarea: restore and attach listeners */
document.querySelectorAll("input,select,textarea").forEach(el=>{
  // restore
  const saved = localStorage.getItem(el.id);
  if(saved !== null) el.value = saved;

  // attach listener
  el.addEventListener("input", ()=>{
    // uppercase enforcement for section1 & section5 inputs
    if( el.closest(".section1") || el.closest(".section5") ){
      // only uppercase text-like inputs (not numeric-only inputs)
      if(el.type !== "number" && el.inputMode !== "numeric" && el.tagName.toLowerCase() !== 'select'){
        el.value = el.value.toUpperCase();
      }
    }
    // save debounced
    debounceSave(()=> saveElValue(el), 120)();
  });
});

/* ---------- Fill PDF ---------- */
async function fillPDF(){
  try {
    $("generate").disabled = true;

    const res = await fetch(PDF_FILENAME);
    if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
    const bytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(bytes);
    const form = pdfDoc.getForm();

    // Section 1
    safeSetText(form, "Cardholder_Name", $("Cardholder_Name").value || "");
    safeSetText(form, "Cardholder_MailingAdd_Line1", $("Cardholder_MailingAdd_Line1").value || "");
    safeSetText(form, "Cardholder_MailingAdd_Line2", $("Cardholder_MailingAdd_Line2").value || "");
    safeSetText(form, "Cardholder_NIRC", $("Cardholder_NIRC").value || "");
    safeSetText(form, "Cardholder_HomeNo", $("Cardholder_HomeNo").value || "");
    safeSetText(form, "Cardholder_MobileNo", $("Cardholder_MobileNo").value || "");

    // CC combined
    const ccCombined = ccDigits.map(d=>d.value.padEnd(4,' ').slice(0,4)).join('').slice(0,16).replace(/\s/g,'');
    safeSetText(form, "CC_Number", ccCombined);

    // Expiry month/year (corrected logic)
    const monthName = $("expiryMonth").value || "";
    const yearValue = $("expiryYear").value || "";
    const expiry = (monthName.trim() === "" || yearValue.trim() === "") ? "" : `${getCorrectMonthValue(monthName)}/${String(yearValue).slice(-2)}`;
    safeSetText(form, "CC_Expirydate", expiry);

    // Banks (checkboxes)
    const bankFields = ["CC_Bank_UOB","CC_Bank_CIMB","CC_Bank_HLB","CC_Bank_PBB","CC_Bank_MBB","CC_Bank_HSBC","CC_Bank_Alliance","CC_Bank_StanChart"];
    bankFields.forEach(b => safeCheck(form, b, false));
    const bankSel = $("CC_Bank_Select").value;
    if (bankSel) safeCheck(form, bankSel, true);

    // Card type
    safeCheck(form, "Visa", false); safeCheck(form, "Master", false);
    const cardType = $("CardType_Select").value; if (cardType) safeCheck(form, cardType, true);

    // EPP Term
    safeCheck(form, "EPPTerm_6Months", false); safeCheck(form, "EPPTerm_12Months", false);
    const term = $("EPPTerm_Select").value; if (term) safeCheck(form, term, true);

    // After EPP frequency
    const afterFields = ["AfterEPP_Annually","AfterEPP_Halfyearly","AfterEPP_Quarterly","AfterEPP_Monthly"];
    afterFields.forEach(a => safeCheck(form, a, false));
    const afterSel = $("AfterEPP_Select").value; if (afterSel) safeCheck(form, afterSel, true);

    // policies rows
    const rows = Array.from(policiesContainer.querySelectorAll(".policy"));
    rows.forEach((row, idx) => {
      const i = idx+1;
      const pNo = row.querySelector(`#Paymentfor_PolicyNo${i}`)?.value || "";
      const owner = row.querySelector(`#Paymentfor_PolicyNo${i}_OwnerName`)?.value || "";
      const rel = row.querySelector(`#Paymentfor_PolicyNo${i}_Relationship`)?.value || "";
      const firstPrem = row.querySelector(`#Paymentfor_PolicyNo${i}_FirstPremium`)?.value || "";
      safeSetText(form, `Paymentfor_PolicyNo${i}`, pNo);
      safeSetText(form, `Paymentfor_PolicyNo${i}_OwnerName`, owner);
      safeSetText(form, `Paymentfor_PolicyNo${i}_Relationship`, rel);
      safeSetText(form, `Paymentfor_PolicyNo${i}_FirstPremium`, firstPrem);
    });
    for(let i = rows.length+1; i<=MAX_POLICIES; i++){
      safeSetText(form, `Paymentfor_PolicyNo${i}`, "");
      safeSetText(form, `Paymentfor_PolicyNo${i}_OwnerName`, "");
      safeSetText(form, `Paymentfor_PolicyNo${i}_Relationship`, "");
      safeSetText(form, `Paymentfor_PolicyNo${i}_FirstPremium`, "");
    }

    // Section 5
    safeSetText(form, "Signed_State", $("Signed_State").value || "");
    safeSetText(form, "Signed_Month", $("Signed_Month").value || "");
    safeSetText(form, "Signed_Day", $("Signed_Day").value || "");
    safeSetText(form, "Signed_Year", $("Signed_Year").value || "");
    safeSetText(form, "Witness_Name", $("Witness_Name").value || "");
    safeSetText(form, "Witness_NRIC", $("Witness_NRIC").value || "");

    // Embed signatures on PAGE 3 (index 2)
    const pages = pdfDoc.getPages();
    const pageForSign = pages[2]; // Index 2 is the 3rd page
    const poSig = localStorage.getItem('cardholder_sig');
    const wSig = localStorage.getItem('witness_sig');

    const sigWidth = 160, sigHeight = 50; // default embed size, adjust if needed
    if(poSig){
      try{
        const pngBytes = await fetch(poSig).then(r=>r.arrayBuffer());
        const png = await pdfDoc.embedPng(pngBytes);
        pageForSign.drawImage(png, { x: 360, y: 120, width: sigWidth, height: sigHeight });
      }catch(e){ console.warn("Cardholder signature embed failed:", e); }
    }
    if(wSig){
      try{
        const pngBytes2 = await fetch(wSig).then(r=>r.arrayBuffer());
        const png2 = await pdfDoc.embedPng(pngBytes2);
        pageForSign.drawImage(png2, { x: 140, y: 120, width: sigWidth, height: sigHeight });
      }catch(e){ console.warn("Witness signature embed failed:", e); }
    }

    // Save & download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "Filled_ZeroInterest_EPP.pdf"; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2500);

  } catch (err) {
    console.error(err);
    alert("PDF generation failed: " + (err.message || err));
  } finally {
    $("generate").disabled = false;
  }
}

/* ---------- Reset All ---------- */
function resetAll(){
  document.querySelectorAll("input").forEach(inp=>{ if(inp.type==='checkbox' || inp.type==='radio') inp.checked=false; else inp.value=''; });
  document.querySelectorAll("select").forEach(s=> s.selectedIndex = 0);
  localStorage.clear();
  // remove policy nodes and recreate
  policiesContainer.innerHTML = ""; policyCount = 0; addPolicyBtn.disabled=false; addPolicy();
  // restore previews empty
  previews.cardholder.innerHTML = `<span>Tap to Sign (Cardholder)</span>`;
  previews.witness.innerHTML = `<span>Tap to Sign (Witness)</span>`;
}

/* ---------- Wire events ---------- */
$("generate").addEventListener("click", fillPDF);
$("resetAll").addEventListener("click", resetAll);

/* ---------- Restore saved form values on load ---------- */
(function restoreSavedValues(){
  document.querySelectorAll("input,select,textarea").forEach(el=>{
    const saved = localStorage.getItem(el.id);
    if(saved !== null) el.value = saved;
  });
  restoreSignaturePreviews();
})();

/* ---------- Small nicety: show Save indicator when localStorage is updated by other code ---------- */
window.addEventListener('storage', ()=> showSaveStatus());
</script>

</body>
</html>
